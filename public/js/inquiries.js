Plex.inquiries = {
    contactSection: '#_contactMessage',
	remove_this : -1,
	removeFromApproveSuccessMsg : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully removed from your Handshakes list',
        type: 'soft',
        dur : 5000
    },
    updatedStudentApplicationState : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student\'s application state has been successfully updated',
        type: 'soft',
        dur : 5000
    },
    updatedStudentApplicationStatus : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student\'s application status has been successfully updated',
        type: 'soft',
        dur : 5000
    },
    fileUploadSuccessMsg: {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'File has successfully been uploaded',
        type: 'soft',
        dur : 6000
    },
    fileRemoveSuccessMsg: {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'File has successfully been removed',
        type: 'soft',
        dur : 6000
    },
    promoteVerifiedHsSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully promoted to a Verified Handshake',
        type: 'soft',
        dur : 6000
    },
    promoteVerifiedPSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully promoted to a Verified Prescreen',
        type: 'soft',
        dur : 6000
    },
    promoteVerifiedASuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully promoted to a Verified Application',
        type: 'soft',
        dur : 6000
    },
    promoteHsSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully promoted to a Handshake',
        type: 'soft',
        dur : 6000
    },
    promoteConvertedSuccess: {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully promoted to a Converted',
        type: 'soft',
        dur : 6000
    },
    promoteUndoSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'The promotion has successfully been undone',
        type: 'soft',
        dur : 6000
    },
    removeFromPendingSuccessMsg : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully removed from your Pending list',
        type: 'soft',
        dur : 5000
    },
    addedFromInquiriesToApproved : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been added to your Handshakes list',
        type: 'soft',
        dur : 5000
    },
    addedFromRecommendedToPending : {
    	textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been added to your Pending list',
        type: 'soft',
        dur : 5000
    },
    restoreFromRemovedMsg : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully restored from your removed list, and is in your Handshakes list',
        type: 'soft',
        dur : 5000
    },
    restoreFromRemovedToInquiriesMsg: {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully restored to your Inquiries list',
        type: 'soft',
        dur : 5000
    },
    promoteVerifiedError: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'An error occured while trying to promote the student to Verified',
        type: 'soft',
        dur: 7000
    },
    saveProfileError: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'An error occured while trying to save new profile information',
        type: 'soft',
        dur: 7000
    },
    updatedStudentApplicationStateFailure: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'An error has occured while trying to update the student\'s application state',
        type: 'soft',
        dur : 7000
    },
    updatedStudentApplicationStateFailure: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'An error has occured while trying to update the student\'s application status',
        type: 'soft',
        dur : 000
    },
    moveToTemplate: {
        textColor: '#fff',
        bkg: 'green',
        msg: 'The student has been moved to ',
        type: 'soft',
        dur: 7000
    },
    editFormErrorInputs: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'There are invalid form inputs',
        type: 'soft',
        dur: 9000
    },
    error: {
        textColor: '#fff',
        bkg: '#DD1144',
        msg: 'An error occured',
        type: 'soft',
        dur: 7000
    },
    postStudentMsg: {
        textColor: '#fff',
        bkg: 'green',
        msg: 'The student has been posted the following school.',
        type: 'soft',
        dur: 7000
    },
    postStudentMsgRejected: {
        textColor: '#fff',
        bkg: 'red',
        msg: 'The student has been rejected, refresh to see the error',
        type: 'soft',
        dur: 7000
    },
    removeFromPrescreenedSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully removed from your PreScreened list.',
        type: 'soft',
        dur : 5000
    },
    removeFromPrescreenedFailed: {
        textColor: '#fff',
        bkg: 'red',
        msg: 'There\'s an issue removing this student, contact collegeservices@plexuss.com for further troubleshooting',
        type: 'soft',
        dur: 7000
    },
    addStudentManuallyMsg : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been added to {{school_name}} {{type}} List',
        type: 'soft',
        dur : 8000
    },
    removeFromInquiriesSuccess : {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Student has been successfully removed from your Inquiries list.',
        type: 'soft',
        dur : 5000
    },
    removeFromInquiriesFailed: {
        textColor: '#fff',
        bkg: 'red',
        msg: 'There\'s an issue removing this student, contact collegeservices@plexuss.com for further troubleshooting',
        type: 'soft',
        dur: 7000
    },
    leadSuccessfullyPosted: {
        textColor: '#fff',
        backGroundColor : 'green',
        msg: 'Lead has successfully been posted.',
        type: 'soft',
        dur : 8000
    },
    saveNotesInterval : '',
    plexussSaveNotesInterval: '',
    activeTab: null,
    adminType: null,
    tags: [],
    owl: null,
    unique: 1,
    uniqueMatched: 1,
    _this: null,
    initData: null,
    cityInitDone: false,
    majorInitDone: false,
    sections: null,
    ranges: ['0.00','0 - 5,000','5,000 - 10,000', '10,000 - 20,000', '20,000 - 30,000', '30,000 - 50,000', '50,000'],
    ranges_formatted:  ['$0','$0 - $5,000','$5,000 - $10,000', '$10,000 - $20,000', '$20,000 - $30,000', '$30,000 - $50,000', '$50,000+']
}

//abide validation pattern definition
$(document).foundation({
    abide : {
        patterns: {
            age: /^([1-9]?\d|100)$/, /*
            gpa: /^(?:[0-3]?\.{1}\d{1,2}|[0-4]{1}\.{1}[0]{1,2}|[0-4]{1}){1}$/,    // /^(?!0$)(([0-3]){1}\.([0-9]){1,2}|4\.(0){1,2}|([0-4]){1})$/,
            toefl: /^([0-9]?[0-9]|[1][0-1][0-9]|12[0])$/,
            ielts: /^[0-9]{1}$/,
            sat: /^([6-9][0-9][0]|[1][0-9][0-9][0]|[2][0-3][0-9][0]|[2][4][0][0])$/,
            act: /^([1-9]|[1-2][0-9]|[3][0-6])$/, */
            name: /^[a-zA-Z\,\'\-]*$/,
            nameemail: /^[a-zA-Z0-9,.-_'!#$%&*+/=?^`{|}~ ]$/,
            address: /^[a-zA-Z0-9\.,#\-\' ]+$/,
            state: /^[a-zA-Z\.\-\' ]+$/,
            city: /^[a-zA-Z\.\-\' ]+$/,
            zip: /^[a-zA-Z0-9\.,\- ]+$/,
            phoneinput : /^\s*(?:\+?(\d{1,3}))?[-. (]*(\d{3})[-. )]*(\d{3})[-. ]*(\d{4})(?: *x(\d+))?\s*$/,
            alpha_space : /^[a-zA-Z ]*$/,
            college_name: /^[\s]*(([a-zA-Z])+([\s]|[\-]|['])*)+[\s]*$/,
            dashes_only: /^[0-9-]*$/,
            number: /^[-+]?[0-9]\d*$/,
            month : /^[-+]?[0-9]\d*$/,
            gpa: /^(([0-3]){1}\.([0-9]){1,2}|4\.(0){1,2}|([0-4]){1})$/,
            max_weighted_gpa: /^(([0-9])+|([0-9])+\.([0-9]){1,2})$/,
            act: /^([0-9]|[1-2][0-9]|[3][0-6])$/,
            sat: /^([6-9][0-9][0]|[1][0-9][0-9][0]|[2][0-3][0-9][0]|[2][4][0][0])$/,
            sat_total:/^([6-9][0-9][0]|[1][0-9][0-9][0]|[2][0-3][0-9][0]|[2][4][0][0])$/,
            toefl: /^[\s]*([0-9]{1,2}|[1][0-1][0-9]|[1][2][0])[\s]*$/,
            ielts: /^[\s]*([0-8]{0,1}[\.][0-9]|[0-9]|9.0)[\s]*$/,
            itep: /^[\s]*([0-5]{0,1}[\.][0-9]|[0-6]|6.0)[\s]*$/,
            pte: /^[\s]*([1-8][0-9]|90)[\s]*$/
        },
        validators:{
            monthChecker: function(el, required, parent){
                var value = $(el).val();
                if ( ($.isNumeric(value) && value <= 12 && value > 0 )|| value.trim() === '' ) {
                    $('.datedMonthError').css('display', 'none');
                    return true;
                } else{
                    $('.datedMonthError').css({
                        'display': 'inline-block',
                        'margin-bottom': '2px'
                    });
                    return false;
                };
            },
            dayChecker: function(el, required, parent){
                var value = $(el).val();
                if ( ($.isNumeric(value) && value <= 31 && value >= 1)  || value.trim() === '' ) {
                    $('.datedDayError').css('display', 'none');
                    return true;
                } else{
                    $('.datedDayError').css({
                        'display': 'inline-block',
                        'margin-bottom': '2px'
                    });
                    return false;
                };
            },
            yearChecker: function(el, required, parent){
                var value = $(el).val();
                var currentDate = (new Date).getFullYear();
                var minAgeAllowed = currentDate - 13;

                if( value.trim() === ''){
                    $('.datedYearError').css('display', 'none');
                    $('.datedUnderAge').css('display', 'none');
                    return true;
                }
                else if( !$.isNumeric(value) || value > currentDate || value <=  currentDate - 100 ){
                    $('.datedYearError').css({
                        'display': 'inline-block',
                        'margin-bottom': '2px'
                    });
                    return false;
                } else if ( value > minAgeAllowed) {
                    $('.datedUnderAge').css({
                        'display': 'inline-block',
                        'margin-bottom': '2px'
                    });

                    $('.agenotice').css({
                        'color':'#FF7F00',
                        'font-weight':'bold'
                    });
                    return false;
                }else{
                    $('.datedYearError').css('display', 'none');
                    $('.datedUnderAge').css('display', 'none');
                    return true;
                };
            }
        }
    }

});


////////////////////////////////////
Plex.inquiries.makeUploadIcon = function(type){

   return '<li class="mr3 has-tip uploaded-docs-thumb uploadDocsSpriteSmall ' +
              type + 
          '" data-tooltip="" aria-haspopup="true" data-selector="tooltip-j4edcohow" aria-describedby="tooltip-j4edcohow" title="">&nbsp;</li>';
};




//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// Auto expand note section when user i writing
$(document).one('focus.notes-textarea', 'textarea.notes-textarea', function(){
    var savedValue = this.value;
    this.value = '';
    this.baseScrollHeight = this.scrollHeight;
    this.value = savedValue;
    var minRows = this.getAttribute('data-min-rows')|0, rows;
    this.rows = minRows;
    rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 16);
    this.rows = minRows + rows;
}).on('input.notes-textarea', 'textarea.notes-textarea', function(){
    var minRows = this.getAttribute('data-min-rows')|0, rows;
    this.rows = minRows;
    rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 16);
    this.rows = minRows + rows;
});

$(document).one('focus.plexuss-notes-textarea', 'textarea.plexuss-notes-textarea', function(){
    var savedValue = this.value;
    this.value = '';
    this.baseScrollHeight = this.scrollHeight;
    this.value = savedValue;
    var minRows = this.getAttribute('data-min-rows')|0, rows;
    this.rows = minRows;
    rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 16);
    this.rows = minRows + rows;
}).on('input.plexuss-notes-textarea,', 'textarea.plexuss-notes-textarea', function(){
    var minRows = this.getAttribute('data-min-rows')|0, rows;
    this.rows = minRows;
    rows = Math.ceil((this.scrollHeight - this.baseScrollHeight) / 16);
    this.rows = minRows + rows;
});
////

$(document).ready(function() {
    var searchCollegeMatchTimeOut = null;

    Plex.inquiries.majorsList = new MajorCrumbList;

    Plex.inquiries.adminType = $('.student-search-container').data('admin-type');

    Plex.inquiries.ifRedirectBackFromExport();

    //init section objs
    Plex.inquiries.initSections();

    Plex.inquiries.initBucketsCount();

    // Plex.inquiries.initOwlCarousel();

	var hasResultsOnLoad = $('.each-inquirie-container').data('has-results');
	Plex.inquiries.injectLoadMoreButton();
	Plex.inquiries.hasResultsCheck(hasResultsOnLoad);

	// var current_viewing = $('.each-inquirie-container').data('current-viewing');
	// var total_results = $('.each-inquirie-container').data('total-results');

	// $('.each-inquirie-container .showResults').html(Plex.inquiries.injectResults(current_viewing, total_results));




    //////////////////////////////////////////////////////////////
    $(document).on('click', '.upload-menu-toggle', function(){

        $('.upload-type-menu').slideUp(300);

        slideMenu( $(this).find('.upload-type-menu'), 300);
    });


    //////////////////////////////////////////////////////////////
    $(document).on('mouseenter', '.upload-icon-hover', function(e){
        e.stopPropagation();
        $(this).closest('.upload-menu-toggle').find('.upload-type-tooltip').fadeIn(100);
    });

    //////////////////////////////////////////////////////////////
    $(document).on('mouseleave', '.upload-icon-hover', function(e){
        e.stopPropagation(); 
        $(this).closest('.upload-menu-toggle').find('.upload-type-tooltip').fadeOut(100);
    });

    //////////////////////////////////////////////////////////////
    $(document).on('mouseenter', '.upload-change-type', function(e){
        e.stopPropagation();
        var type = $(this).data('type');
        var top = $(this).position().top + 56; //e.pageY - $(this).offset().top;
        var tooltip = $(this).closest('.upload-menu-container').find('.upload-option-tooltip.' + type);

        tooltip.css('top', top);

        tooltip.fadeIn(100);
    });

     //////////////////////////////////////////////////////////////
    $(document).on('mouseleave', '.upload-change-type', function(e){
        e.stopPropagation();
        var type = $(this).data('type');
        var tooltip = $(this).closest('.upload-menu-container').find('.upload-option-tooltip.' + type);

        tooltip.fadeOut(100)
    });


    /////////////////////////////////////////////////////////
    $(document).on('click', function(e){

       $('.upload-type-tooltip').fadeOut(100);
       $('.upload-option-tooltip').fadeOut(100);


       if($(e.target).closest('.upload-menu-toggle').length === 0)
            $('.upload-type-menu').slideUp(300);            

    });


    ///////////////////////////////////////////////////////////////
    $(document).on('click','.upload-change-type', function(){

        var type = $(this).data('type'); //new type user intends to change to
        var id = $(this).closest('.edit-upload-item-container').find('.remove-upload-btn').data('transcript-id'); //transcript id
        var cont = $(this).closest('.edit-upload-item-container').find('.upload-menu-toggle');
        var menuToggleIcon = cont.find('.upload-icon-hover');
        var ctype = cont.data('ctype'); //current type

        menuToggleIcon.removeClass(ctype);
        menuToggleIcon.addClass(type);
        menuToggleIcon.attr('data-ctype', type);

        cont.attr('data-ctype', type);
        cont.data('ctype', type);
        cont.attr('data-transcript-id', id);
        cont.attr('data-changed', '1');

    });


////////////////////////////////////////////////////////////////////
    $(document).on('focusin', '.collegeSearch', function(){
        $(this).val(' ');

        $(this).one('focusout', function(){
            $(this).val('Search for a college...');
        });
    });

    
    ////////////////////////////////////////////////////////////////////
    //+ADD btn
    $(document).on('click', '.add-college-matches-btn', function(e){
    
        //show modal --parent class very generic ... parent().parent()..
        $(this).parent().parent().parent().find('.add_college_modal').toggle();
        $(this).parent().parent().parent().find('.matched_colleges_container').toggle();
        
        //change add btn to reflect opened/closed state
        if($(this).hasClass('closed-color')){
            $(this).removeClass('closed-color');
            $(this).addClass('opened-color');
        }
        else{
            $(this).addClass('closed-color');
            $( this).removeClass('opened-color');   
        }

        $(this).find('.college-add-btn').toggle();
        $(this).find('.college-close-btn').toggle();

    });



    /////////////////////////////////////////////////////////////////////
    //get results as typing in search field
    $(document).on('keyup', '.collegeSearch', function(event){

        var el = $(this).closest('.add_college_modal').find('.collegeResults');
        var data = {
            keyword: $(event.target).val()
        };

        clearInterval(searchCollegeMatchTimeOut);

        searchCollegeMatchTimeOut = setTimeout(function() {
            el.html('<div class="add-college-loader"></div>');  //clear search box to repopulate with new results

            $.ajax({
                url: '/admin/studentsearch/searchForCollegesByKeyword',
                type: 'POST',
                data: data,
                headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
            }).done(function(data){
                
                el.html(''); // Clear loader
                
                if(data.length === 0 )
                    el.text('No results found.');

                for(var i in data){
                    //create listing for college and insert into #collegeResults
                    var div = $("<div>", {"class": "row college-listing-cont green-h college-listing-with-handler"});
                    var picdiv = $("<div>", {"class": "column large-2  medium-2 small-2 college-icon-cont"});
                    var pic = $("<img>", {"src": 'https://s3-us-west-2.amazonaws.com/asset.plexuss.com/college/logos/' + data[i].logo_url});
                    var descContain = $("<div>", {"class": "column large-10 medium-10 small-10 college-desc-cont"});
                    var collegeName = $("<div>", {"class" : "match-college-name"});
                    var collegeLoc = $("<div>", {"class" : "match-college-place"});


                    //attatch college_id to div?
                    div.data('info', data[i].college_id);

                    collegeName.html(data[i].school_name);
                    collegeLoc.html(data[i].city +  ', ' + data[i].state);

                    picdiv.append(pic);
                    descContain.append(collegeName);
                    descContain.append(collegeLoc);
                    
                    div.append(picdiv);
                    div.append(descContain);
                    
                    el.append(div);
                }
            }).fail(function(){
                el.html('Error trying to get results.');
            });
        }, 500);
            
    });

    //////////////////////////////////////////////////////////////////
    //selecting college
    $(document).on('click', '.college-listing-with-handler', function(e){
        
        var el = e.target;
        var element = el.closest('.college-listing-cont');

        var pCont = $(this).parent().parent().parent();     //parent container

        //get image, college name, college location from first screen
        //populate them in next screen
        var name = $(element).find('.match-college-name').text();
        var place = $(element).find('.match-college-place').text();
        var picsrc = $(element).find('.college-icon-cont img').attr('src');

        var portalCont = pCont.find('.portals-radio-container');  //portals container
        
        //grab college_id
        var collegeId = $(element).data('info');

        //create listing for college and insert into .college-head
        var div = $("<div>", {"class": "row college-listing-cont", "data-info": collegeId});
        var picdiv = $("<div>", {"class": "column large-2 medium-2 small-2 college-icon-cont"});
        var pic = $("<img>", {"src": picsrc});
        var descContain = $("<div>", {"class": "column large-10 medium-10 small-10 college-desc-cont"});
        var collegeName = $("<div>", {"class" : "match-college-name"});
        var collegeLoc = $("<div>", {"class" : "match-college-place"});

        collegeName.html(name);
        collegeLoc.html(place);

        picdiv.append(pic);
        descContain.append(collegeName);
        descContain.append(collegeLoc);
        
        div.append(picdiv);
        div.append(descContain);

        pCont.find('.college-head').html(div);

        var data = {
            college_id: collegeId
        };

        //show loading before ajax completed
        portalCont.html('<div class="add-college-loader"></div>');

        //get portals
        $.ajax({
            url: '/admin/studentsearch/getOrganizationPortalsForThisCollege',
            type: 'POST',
            data: data,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},

        }).done(function(data){

            portalCont.html('');

            var gradio = $('<input>' , {'type': "radio", 'name':"portal", 'id': 'generalPortal'});
            var glabel = null;

            if(data.general.org_portal_name)
                glabel = $('<label>', {'for': 'generalPortal' }).text(' ' + data.general.org_portal_name);
            else
                glabel = $('<label>', {'for': 'generalPortal' }).text(' ' + data.general.aor_portal_name);

            glabel.prepend(gradio);

            portalCont.append(glabel);
            gradio.data('aorId', data.general.aor_id);
            gradio.data('orgId', data.general.org_portal_id);
            gradio.data('aorPortalId', data.general.aor_portal_id);
            
            //for each portal, add a radio button
            var radio, label;
            for(var i in data.portals){
                
                radio = $('<input>' , {'type': "radio", 'name':"portal", 'id': 'portal'+i});
                

                // portalCont.append(radio);

                label = $('<label>', {'for': 'portal'+i });

                //should always be that there is an org portal if no aor, if aor no org portal
                if(data.portals[i].org_portal_name != null){
                    radio.val(data.portals[i].org_portal_name);
                    label.text(' ' + data.portals[i].org_portal_name);
                }
                else{
                    radio.val(data.portals[i].aor_portal_name);
                    label.text(' ' + data.portals[i].aor_portal_name);
                }

                label.prepend(radio);

                portalCont.append(label);

                //set org and aor ids
                //if not org then aor
                if(!data.portals[i].org_portal_id){
                    radio.data('aorId', data.portals[i].aor_id);
                    radio.data('aorPortalId', data.portals[i].aor_portal_id);
                    radio.data('orgId', -1);
                }else{
                    radio.data('aorId', -1);
                    radio.data('aorPortalId', -1);
                    radio.data('orgId', data.portals[i].org_portal_id);
                }
            }
        });     

        //show next step
        pCont.find('.s1').hide();
        pCont.find('.s2').show();

    });

    /////////////////////////////////////////////////////
    //back buttons and transitions from part 2 to 3
    $(document).on('click', '.add-modal-container .back-to-colleges-btn', function(){

        var pCont = $(this).closest('.add_college_modal'); //parent container

        pCont.find('.s1').show();
        pCont.find('.s2').hide();
    });

    $(document).on('click', '.add-modal-container .back-to-portals-btn', function(){

        var pCont = $(this).closest('.add_college_modal'); //parent container

        pCont.find('.s2').show();
        pCont.find('.s3').hide();
    });

    $(document).on('click', '.add-modal-container .select-portal-btn', function(event){
        event.preventDefault();

        var parent = $(this).closest('.add-modal-container');

        var portal = parent.find('.portals-radio-container input[type="radio"]:checked');

        if (portal.length == 0) { return; }

        parent.find('.s2').hide();
        parent.find('.s3').show();

    });
    ////////////////////////////////////////////////////////////



    //Add School button
    $(document).on('click', '.add-modal-container .add-college-btn', function(e){

        e.preventDefault();
        
        var pCont = $(this).closest('.add_college_modal');
        
        //get checked bucket and portal
        var bucket = pCont.find('.buckets-radio-container input[type="radio"]:checked');
        var portal = pCont.find('.portals-radio-container input[type="radio"]:checked');

        if (bucket.length == 0 || portal.length == 0 || !bucket.prop('value')) { return; }

        //get college info from last step( step 2) -- not same place as step 1
        var el = $('.add_college_modal .step2.college-head');
        var name =  el.find('.match-college-name').text();
        var place = el.find('.match-college-place').text();
        var picsrc = el.find('.college-icon-cont img').attr('src');
        
        var ele = el.find('.college-listing-cont');

        //grab college_id
        var collegeId = ele.data('info');

        //get portal ids (set with Jquery .data())
        var userId = $('#student_info').val();
        var aorId = portal.data('aorId');
        var orgId = portal.data('orgId');
        var aorPortalId = portal.data('aorPortalId');
        //console.log(aorId + ' ' + orgId + ' ' + aorPortalId);
        Plex.inquiries.addStudentManual(bucket.prop('value'), userId , collegeId , aorId, orgId, aorPortalId, name, function(){
            
            //close this modal once done
            pCont.hide();
            var parent = pCont.parent();
            parent.find('.matched_colleges_container').show();
            //swtich back to step 1
            pCont.find('.s1').show();
            pCont.find('.s2').hide();
            pCont.find('.s3').hide();


            //change ADD btn to reflect opened/closed state
            if(parent.find('.add-college-matches-btn').hasClass('opened-color')){
                parent.find('.add-college-matches-btn').addClass('closed-color');
                parent.find( '.add-college-matches-btn').removeClass('opened-color');   
                parent.find('.college-add-btn').toggle();
                parent.find('.college-close-btn').toggle();
            }
        });
                
    });

    //update clock on pending/approved pages
    // setInterval(function(){
    // document.getElementById("updatetime").innerHTML = (new Date()).toLocaleTimeString();
    // }, 1000);   

    ////////////////////////////
    //   sticky action bar when scrolling to end of profile height
    //

    //handler to close box if clicking outside it
    $(document).on('click', function(e){
       
        //if is filter audience button , just return as it has it's own handling
        if($(e.target).closest('a.ms-btns.filter-audience').length){
            // $('#filter-options').toggle();
         return;
        }

        //if not in filter options box 
        if($(e.target).closest('#filter-options').length === 0 ){
            if( !$(e.target).hasClass('remove-tag') ){
                $('#filter-options').hide();
                Plex.inquiries.switchIcon($('a.ms-btns.filter-audience')); 
            }
        }
    });



    ///// toggle sub menus on mobile actionbar menu ////
    $(document).on('click', '.actionbar-dropdown-menu', function(e){
        e.stopPropagation();

        var drop = $(this).children();
        if(drop.is(':hidden')){
            drop.slideDown();
            $(document).one('click', function(e){
                if($(e.target).closest('.actionbar-dropdown-menu li').length === 0)
                    drop.slideUp();
            });
        }else{
            drop.slideUp();
        }
    });


    ////// submenus for actionbar dropdown /////
    $(document).on('click', '.actionbar-dropdown-menu li', function(e){
        e.stopPropagation();

        var drop = $(this).children('ul');
        if(drop.length && drop.is(':hidden')){
            drop.slideDown();
        }else{
            drop.slideUp();
        }
    });


    /////// toggle colors and menu when selecting dropdowns -- currently handles both promote and status 
    $(document).on('click', '.actionbar-btn', function(e){
        //e.stopPropagation();
        if($(this).hasClass('promote-identifier') || $(this).hasClass('status-identifier') || $(this).hasClass('state-identifier')){
            var menu = null;
            var that = $(this);
            var button = that.closest('.actionbar-btn');

            if($(this).find('.promote_menu').length)
                menu = $(this).find('.promote_menu')
            else if($(this).find('.state-menu').length)
                menu = $(this).find('.state-menu'); 
            else 
                menu = $(this).find('.status-menu');

            menu.toggle();

            //if menu is displayed
            if(menu.is(':visible')){  

                button.addClass('actionbar-btn-active');
                button.removeClass('actionbar-btn-notactive');
                if(!button.hasClass('actionbar-btn-updated')){
                    button.find('.promote-arrow').addClass('promote-arrow-active');
                    button.find('.promote-arrow').removeClass('promote-arrow-notactive');    
                }
               
                //close menus if clicking outside of it
                $(document).one('click', function(e){

                    if(!$(e.target).hasClass('actionbar-btn') && $(e.target).parents('.actionbar-btn').length === 0){
                            menu.hide();
                            
                            if(button.hasClass('actionbar-btn-active')){
                                button.removeClass('actionbar-btn-active');
                                button.addClass('actionbar-btn-notactive');
                                button.find('.promote-arrow').addClass('promote-arrow-notactive');
                                button.find('.promote-arrow').removeClass('promote-arrow-active');
                            }
                    }
                });

            //if menu is not displayed    
            }else{
           
                button.removeClass('actionbar-btn-active');
                button.addClass('actionbar-btn-notactive');

                if(!button.hasClass('actionbar-btn-updated')){
                    button.find('.promote-arrow').addClass('promote-arrow-notactive');
                    button.find('.promote-arrow').removeClass('promote-arrow-active');
                }

            }

           
        }
    });


    /////// handle state dropdown selection
    $(document).on('click', '.state-menu li', function(e){
        e.stopPropagation();
        var prev_state = $(this).closest('.state-identifier').find('.promote-text').text()
                                .trim().split(/\s+/).join('_').toLowerCase();
        var selection = $(this).text();
        var selection_formatted = selection.split(/\s+/).join('_').toLowerCase();
        var that = $(this);
        var menu = that.closest('.state-menu');
        var hid = that.parents('.inquirie_row').data('hashedid');
        var button = that.closest('.actionbar-btn');
        var buttonArrow = button.find('.promote-arrow');
        var data = { hashed_id: hid, state: selection_formatted,  prev_state: prev_state };

        Plex.inquiries.showLoader();   

        $.ajax({
            url: '/admin/inquiries/updateUserApplicationState',
            type: 'POST',
            data: data,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(){
            button.find('.promote-text').text(selection);
            button.removeClass('actionbar-btn-active');
            button.addClass('actionbar-btn-notactive');
            buttonArrow.removeClass('promote-arrow-active');
            buttonArrow.addClass('promote-arrow-notactive');

            menu.hide();
            Plex.inquiries.hideLoader();
            topAlert(Plex.inquiries.updatedStudentApplicationState);
        }).fail(function(){
            Plex.inquiries.hideLoader();
            menu.hide();
            topAlert(Plex.inquiries.updatedStudentApplicationStateFailure);
        });

    });


    /////// handle Status dropdown selection
    $(document).on('click', '.status-menu li', function(e){
         e.stopPropagation();
        var selection = $(this).text();
        var that = $(this);
        var menu = that.closest('.status-menu');
        var uid = that.parents('.inquirie_row').data('uid');
        var button = that.closest('.actionbar-btn');
        var buttonArrow = button.find('.promote-arrow');
        var url = '/admin/inquiries/';
        var data = {};

        Plex.inquiries.showLoader();

        if(selection === 'Undo Status Update'){
            url = url + 'undoPlexussUserVerificationStatus';
            data = {
                    user_id: uid
                };
        }
        else{
            url = url + 'savePlexussUserVerificationStatus';
            data = {
                    user_id: uid,
                    status: selection
                };
        }       

        $.ajax({
            url: url,
            type: 'POST',
            data: data,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(){

            if(!menu.hasClass('status-menu-small')){
                if(selection === 'Undo Status Update')
                    button.find('.promote-text').text('Status');
                else
                    button.find('.promote-text').text(selection);

                button.removeClass('actionbar-btn-active');
                button.addClass('actionbar-btn-notactive');
                buttonArrow.removeClass('promote-arrow-active');
                buttonArrow.addClass('promote-arrow-notactive');
            }else{

                if(selection === 'Undo Status Update')
                    menu.parents('li').find('.actionbar-status-small').text('');
                else
                    menu.parents('li').find('.actionbar-status-small').text(selection);
            }
            menu.hide();
            Plex.inquiries.hideLoader();
        });

    });



    /////// handle Promote to dropdown selection 
    $(document).on('click', '.promote_menu li', function(e){
        e.stopPropagation();
       
        var selection = $(this).text();
        var cpage  = $(this).parents('.each-inquirie-container').data('page-type') || '';
        var row = $(this).parents('.student-profile-pane');
        var rec = row.data('recid') || '';
        var that = $(this);
        var button = that.closest('.actionbar-btn');
        var buttonArrow = button.find('.promote-arrow');
        hid = that.closest('.actionbar-container').data('uhid');

        var rurl = '';
        var data = { user_id: hid,
                     page: cpage,
                     rec_id: rec   
                    };

        
        switch(selection){
            case 'Verified Handshakes':
                rurl = '/admin/inquiries/verifiedHs/saveVerifiedHandShake';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Verified Prescreen':
                rurl = '/admin/inquiries/prescreened/savePrescreenedUser';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Verified Applications':
                rurl = '/admin/inquiries/verifiedApp/saveVerifiedApplication';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Handshakes':
                rurl = '/admin/inquiries/setAddToH';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Undo Promote Verified Handshakes':
                rurl = '/admin/inquiries/verifiedHs/undoVerifiedHandShake';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Undo Promote Verified Applications':
                rurl = '/admin/inquiries/verifiedApp/undoVerifiedApplication';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            case 'Converted':
                rurl = '/admin/inquiries/moveStudentToConverted';
                Plex.inquiries.promoteUserVerified(button, buttonArrow, that, rurl, data, selection);
                break;
            default:
                break;

        }


    });

    ///////// show or hide address in dropdown profile
    $(document).on('click', '.add-show-more', function(){
        var that = $(this);
        var text = that.text();

        that.parent().find('.address-more-info').toggle();
        if(text === 'Show')
            that.text('Hide');
        else
            that.text('Show');
    });


    //////// verify a contact handler (sales)
    //  green checkmark next to contact info
    //
    $(document).on('click', '.contact-verify', function(e){
        //send post ajax to set verified contact
        var me = $(this);
        var inqRow = me.closest('.inquirie_row');
        var uid = me.parents('.inquirie_row').data('uid');
        var type = me.parent().find('.c-info-label').text();
        var data = {user_id: uid};

        var verified = false;
        var url = '/admin/inquiries/savePlexussUserInfo';

        if(!me.hasClass('verified')){
            verified = true;
        }


        //changed to reflect backend
        if(type === 'Phone'){
            type = 'Phonecall';
        }
        if(type === 'SMS'){
            type= "Phone";
        }


        Plex.inquiries.showLoader();

        data[type + '_verified'] = verified;

        $.ajax({
            url: url,
            type: 'POST',
            data: data,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(response){

            var enbled = inqRow.find('.text-enabled');
            var disbled = inqRow.find('.text-disabled'); 

            if(response === 'success'){
                if(me.hasClass('verified')){
                    me.removeClass('verified');

                }
                else{
                    me.addClass('verified');
                }


                if(type === 'Phonecall'){
                    if(me.closest('.sales-student-edit-pane').length > 0)
                        $('.sales-student-pane #phonecallc').toggleClass('verified');
                    else
                        $('.sales-student-edit-pane #phonecallc').toggleClass('verified');
                }
                if(type === 'Phone'){
                    if(me.closest('.sales-student-edit-pane').length > 0)
                        $('.sales-student-pane #phonec').toggleClass('verified');
                    else
                        $('.sales-student-edit-pane #phonec').toggleClass('verified');

                }



                //show text in contact options
                if(type === 'Phone' && $('.admin_TxtSetup').length > 0){
                    if(me.hasClass('verified')){

                        enbled.removeClass('hide');
                        disbled.addClass('hide');
                    }
                    else{
                        enbled.addClass('hide');
                        disbled.removeClass('hide');
                    }
                    //also toggle the text panel if SMS not enabled (just in case user was on that panel)
                    if(enbled.hasClass('hide'))
                        inqRow.find('.contact-btn-wrapper:first').click();
                }

            }
            else{
                topAlert(Plex.inquiries.error);
            }
            
            Plex.inquiries.hideLoader();
       });
 
    });


    /////////
    $(document).on('mouseenter', '.contact-verify', function(){
        $(this).find('.contact-tooltip').show();
    }); 
    $(document).on('mouseleave', '.contact-verify', function(){
        $(this).find('.contact-tooltip').hide();
    }); 



    /********************** upload modal *********************************/
    //////
    $(document).on('opened.fndtn.reveal', '[data-reveal]', function () {
        var modal = $(this);
        if(modal.is('.upload_docs_modal'))
            $('.reveal-modal-bg').fadeIn();
    });

    ///////
    $(document).on('click', '.actionbar-uploadModal, .edit-new-upload-btn', function() {
        var hash_id = $(this).closest('.actionbar-container').data('uhid') || $(this).closest('.uploads-edit-container').data('uhid');
        $('.upload-files-modal[data-uhid="'+ hash_id +'"]').first().foundation('reveal','open');
    });

    ////////
    $(document).on('click', '.actionbar-upload-btn', function(event) {
        var hash_id = $(this).closest('.upload-files-modal').data('uhid');

        var docType = $(this).find('.actionbar-upload-txt').text().trim().toLowerCase();
        if(docType === 'interview')
            docType = 'prescreen_interview';
        if(docType === 'resume / portfolio')
            docType = 'resume';
        if(docType === 'financial document')
            docType = 'financial';
        var postType = docType + 'upload'; 

        docModal = $('.upload_docs_modal[data-uhid="'+ hash_id +'"]').first();

        docModal.find('input[name="docType"]').attr('value', docType);
        docModal.find('input[name="postType"]').attr('value', 'transcriptupload');

        $(this).closest('.upload-files-modal').foundation('reveal', 'close');
        docModal.foundation('reveal', 'open');
    });

    //////////
    $(document).on('click', '.close-ufModal', function() {
        $(this).closest('.upload-files-modal').foundation('reveal', 'close');
        $('.reveal-modal-bg').fadeOut();
    });

    ///////////
    $(document).on('click', '.close-udModal', function() {
        $(this).closest('.upload_docs_modal').foundation('reveal', 'close');
        $('.reveal-modal-bg').fadeOut();
    });



    /////////
    $(document).on('click', '.upload_docs_form_p .upload-files-btn', function(e){
        e.preventDefault();
        var modal = $(this).parents('.upload_docs_modal');
        var msg = modal.find('.message-box');  
        var form = $(this).parents('.upload_docs_form_p')[0];
        var mdata = new FormData(form);
        var hid = modal.find('[name="_token"]').val();
        mdata.append('hashed_user_id', hid);
        mdata.append('_token', $('meta[name="csrf-token"]').attr('content'));
      
        msg.text('Sending...');

        $.ajax({
            url: '/ajax/profile/uploadcenter/' + $('.upload_docs_form_p').find('[name="_token"]').val(),
            type: 'POST',
            data: mdata,
            cache: false,
            contentType: false,
            processData: false,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(response){
            var res = JSON.parse(response);
            var uid = res['user_id'];
            var rmsg = res['msg'];

            var row =  $('.inquirie_row[data-uid="' + uid + '"]');
            var rowT= row.find('.uploadsDoc ul');

            msg.text('Document uploaded successfully!');
            topAlert(Plex.inquiries.fileUploadSuccessMsg);
            
            setTimeout(function(){
                modal.foundation('reveal','close'); 
                $('.reveal-modal-bg').fadeOut(); 
                msg.text("");
            }, 1000);
            // modal.foundation('reveal','close');
            // $('.reveal-modal-bg').fadeOut();

            //append uploads to view
            var displayName = ''; 
            var rowIcon = $('<li></li>');
            var inconT = '';

            switch(res['doc_type']){
                case 'prescreen_interview':
                    displayName = 'Interview';
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.prescreen_interview').length)
                        rowIcon = $('<li class="uploadDocsSpriteSmall prescreen_interview">&nbsp;</li>');
                    break;
                case 'transcript':
                    displayName = "Transcript";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.transcript').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall transcript">&nbsp;</li>');
                    break;
                case 'financial':
                    displayName = "Financial Docs";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.financial').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall financial">&nbsp;</li>');
                    break;
                case 'resume':
                    displayName = "Resume/Porfolio";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.resume').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall resume">&nbsp;</li>');
                    break;
                case 'passport':
                    displayName = "Passport";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.passport').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall passport">&nbsp;</li>');
                    break;
                case 'toefl':
                    displayName = "TOEFL";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.toefl').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall toefl">&nbsp;</li>');
                    break;
                case 'ielts':
                    displayName = "IELTS";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.ielts').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall ielts">&nbsp;</li>');
                    break;
                case 'essay':
                    displayName = "Essay";
                    //if tile on result bar exist -> nothing
                    if(!rowT.find('.essay').length)
                    rowIcon = $('<li class="uploadDocsSpriteSmall essay">&nbsp;</li>');
                    break;
                default:
                    displayName = 'Other';
                    rowIcon = $('<li class="uploadDocsSpriteSmall other">&nbsp;</li>');
                    break;
            }

            var toolTip = ""; // Only use if label is greater than 17 characters
            var transcriptLabel = ""; // Only use if label is not empty

            if (res['transcript_label'] && res['transcript_label'].toString().trim() !== "") {
                transcriptLabel = res['transcript_label'];

                if (transcriptLabel.length >= 17) {
                    transcriptLabel = transcriptLabel.substr(0, 13) + "...";
                    toolTip = res['transcript_label'];
                }
            }

            var interviewCount = 0;

            if (res['doc_type'] === 'prescreen_interview') {
                interviewCount = row.find('.interview-links').length + 1;

                // Decrement to replace removed interview. This case happens if users delete interviews and add new ones in unpredictable order.
                while (row.find('.edit-uploads-input[placeholder="Interview ' + interviewCount + '"]').length > 0) {
                    interviewCount--;
                }

                var interviewPlayerLink = 
                  '<li class="interview-links" data-transcript-id="' + res['transcript_id'] + '">' +
                      '<div class="sm2-row">' +
                          '<div class="sm2-col sm2-wide">' +
                              '<a type="' + res["mime_type"] + '" href="' + res["path"] + '">' + 
                                 '<b>' + (transcriptLabel || displayName + ' ' + interviewCount) + '</b>' +
                              '</a>' +
                          '</div>' +
                          '<div class="sm2-col">' +
                              '<a href="' + res["path"] + '" target="_blank" title="Download" class="sm2-icon sm2-music sm2-exclude">Download this track</a>' +
                          '</div>' +
                      '</div>' +
                  '</li>';

                row.find('.sm2-playlist-wrapper > ul').append(interviewPlayerLink);
                row.find('.prescreen-interview-title').removeClass('hidden');
                row.find('.prescreen-interview-player').removeClass('hidden');

                Plex.inquiries.resizeInterviewPlayList(row);

            } else {
                var uploadTile = $('<div class="uploadDoc-box" data-transcript-id="' + res['transcript_id'] + '">' +
                    '<div class="row">' +
                        '<div class="column small-12">'+
                            '<div class="uploadDocsSpriteLarge ' + res['doc_type'] + ' "></div>' +
                            
                            '<div class="row uploadDetail">' +
                                '<div class="column small-12" title="' + toolTip + '"><b> ' + (transcriptLabel || displayName) + '</b></div> ' +
                                '<div class="column small-3"><a href="#" onClick="openTranscriptPreview(this);" data-transcript-name="' + res['file_name'] + '">View</a></div>' +
                                '<div class="column small-1">|</div>' +
                                '<div class="column small-3 end"><a href="' + res['path'] + '"> Download</a></div> ' +   
                                '</div></div></div></div>' );   
                row.find('.uploads-display-container > .prescreen-interview-title').before(uploadTile);
            }

            var editUploadTile = '<div class="row collapse edit-upload-item-container mt14">';
            if ( res['doc_type'] == 'prescreen_interview' )
                editUploadTile += '<div class="column mt2 small-1 uploadDocsSpriteInterview interview"></div>';
            else 
                editUploadTile += '<div class="column mt2 small-1 uploadDocsSpriteLarger ' + res['doc_type'] + '"></div>';                 
            editUploadTile += '<div class="column small-9 validSelecto">';

            editUploadTile += '<input value="' + res['transcript_label'] + '" class="edit-uploads-input" placeholder="' + displayName + ((interviewCount > 0) ? " " + interviewCount : "") + '" name="edit-uploads-label" type="text">';
            editUploadTile +='</div><div class="column small-1 remove-upload-btn" data-transcript-id="' + res['transcript_id'] + '" data-doc-type="' + res['doc_type'] + '">Remove</div></div>'
            
            //if this is the firt upload -- remove 'No .. uploads' message
            var none = row.find('.uploads-none');
            if(none.length){
                none.remove();
            }

            row.find(".uploads-edit-container").append(editUploadTile);

            rowT.append(rowIcon);
            
        });

    });
    /******* end uploads *******************/


    ///////// timezone dropdown handler
    $(document).on('click', '.timezone-drop', function(){
        //reveal dropdown with alternate timezones
    });

    

    /********** majors handlers ************************************************/
    ////////// majors for sales edit profile ////////////////
    $(document).on('keyup', '#objMajor', function(e){

        showMajorsList(e);
        getMajors(e);
    });

    /////
    $(document).on('click', '.major-listing-cont', function(e){

        addMajorsHandler(e, Plex.inquiries.majorsList);

    });

    /////////// 
    $(document).on('click', '.obj-close-btn', function(e){

         //remove from crumb list' -- should return new list or null if not able to remove/value not found
        if(Plex.inquiries.majorsList.removeCrumb( e.target.parentNode.getElementsByClassName('crumb-name')[0].innerHTML ) != null){
            
            //if removed from list successfully, remove rendered crumb from view
            var crumb = e.target.parentNode;
            crumb.remove();

            //if list now less than max -- hide the 'reached max note'
            // console.log(Plex.inquiries.majorsList.length());
            if(Plex.inquiries.majorsList.length() < 4 ){
                $(e.target).closest('.majors-container').find('#max-note').hide();
            }
        }
        
    });
    /************* end majors handlers **********************/



    

    /********************** edit dropdown profile handlers ************************/

    ///// dirty flag for changed inputs
    // do not forget -- //on submit must clear all flags
    $(document).on('change', '.salesProfileEdit input', function(e){
        $(this).attr('data-changed', '1');
    });

    $(document).on('change', '.salesProfileEdit select', function(e){
        $(this).attr('data-changed', '1');
    });

    //////// edit student button handler ///////////
    $(document).on('click','.edit-student', function(e){


        var el = $(e.target).closest('.regular-actions');
        var pPane =  el.closest('.inquirie_row').find('.sales-student-pane');
        var other = el.closest('.inquirie_row').find('.sales-student-edit-pane');
        var contactPane = el.closest('.inquirie_row').find('.contact-pane-wrapper');
        
        el.hide();
        pPane.hide();
        contactPane.hide();
        contactPane.removeClass('opened');

        other.show();
        other.find('.edit-actions').show();     

    });

    ////////// save edit student dropdown profile (sales) ///
    $(document).on('click', '.save-edit-btn', function(e){
        // e.preventDefault();
        var row = $(this).parents('.inquirie_row');
        var dataObj = {};
        var majors = [];
        var bday_str = [];
        var that = $(this);

        var currUploads = []; ///store current upload types
                              // to cahnge incons on summary row

        
        dataObj['uploadTypeChange'] = [];
        dataObj['transcript_labels'] = [];


        //will manually check form -- abide not quite working
        if( row.find('#salesProfileEdit input[data-invalid]').length){
            topAlert(Plex.inquiries.editFormErrorInputs);
            return;
        }


        //only send fields that have been changed
        row.find('.salesProfileEdit  [data-changed="1"]').each(function(){
            
            // get all changed inputs as long as they are not empty
            //handle majors, scores, and gpa seperately
            if($(this).attr('name') != 'objMajor' && !$(this).hasClass('userScore') && $(this).attr('name') != 'editGPA' 
            && !$(this).hasClass('bday')
            && !$(this).hasClass('edit-uploads-input')  
            && $(this).val()){
                dataObj[$(this).attr('name')] = $(this).val();
            }
            
            //include scores even if empty
            if($(this).hasClass('userScore'))
                dataObj[$(this).attr('name')] = $(this).val();

            if($(this).attr('name') === 'editGPA'){
                dataObj[$(this).attr('name')] = $(this).val();
            }

            // transcript labels
            if($(this).is('.edit-uploads-input')) {
                var transcript_id = $(this).parents('.edit-upload-item-container').find('.remove-upload-btn').data('transcript-id');
                var new_label = $(this).val();

                dataObj['transcript_labels'].push({
                    id: transcript_id,
                    new_label: new_label
                });
            }

            //transcript type changes
            if($(this).is('.upload-menu-toggle')){
                var type = $(this).data('ctype');
                var id = $(this).data('transcript-id');

                dataObj['uploadTypeChange'].push({
                        id: id,
                        new_type: type
                    });


                row.find('.upload-menu-toggle').each(function(){
                    var type = $(this).data('ctype');
                   
                   currUploads.push(type); 

                   currUploads = currUploads.filter(function( item, index, inputArray ) {
                           return inputArray.indexOf(item) == index;
                    });
                });
                
            }


           
        });

       if(row.find('.salesProfileEdit  .bday[data-changed="1"]')){

            var y = row.find('.salesProfileEdit [name="birthYear"]').val();
            var m = row.find('.salesProfileEdit [name="birthMonth"]').val();
            var d = row.find('.salesProfileEdit [name="birthDay"]').val();
             

            //if any are empty  -- we do not want to change anything except what is not empty -- so set respective value to what it was on load 
            if(m.trim() === ''){
                m = row.find('.birthday-wrapper').data('m');
            }
            if(d.trim() === ''){
                d = row.find('.birthday-wrapper').data('d');   
            }
            if(y.trim() === ''){
                y = row.find('.birthday-wrapper').data('y');
            }


            //must be in two digit format
            if(m.length === 1){
                m = '0' + m;
            }
            if(d.length === 1){
                d = '0' + d;
            }


            bday_str[0]= y;
            bday_str[1]= m;
            bday_str[2]= d;

            dataObj['birthday'] = bday_str.join('-');
       }else{
            dataObj['birthday'] = null;
       }


        
        //plus majors crumbs
        row.find('.crumb-name').each(function(){
            majors.push($(this).text());
        });
        dataObj['majors'] = majors;
        
        dataObj['user_id'] = row.data('uid');
        


        Plex.inquiries.showLoader();

        $.ajax({
            url: '/admin/inquiries/savePlexussUserInfo',
            type: 'POST',
            data: dataObj,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(response){
            if(response === 'failed')
                topAlert(Plex.inquiries.saveProfileError);

            var el = $(e.target).closest('.edit-actions');
            var pPane =  el.closest('.sales-student-edit-pane');
            var other = pPane.parent().find('.sales-student-pane');
              

            //clear all 'dirty' flags -- for next use
            row.find('.salesProfileEdit  [data-changed="1"]').each(function(){

                $(this).removeAttr('data-changed');

            });

            //want to refresh only ajaxed part
            Plex.inquiries.injectProfile(that);

            //and to change the upload icons in summary row
            var docsRow = row.find('ul.uploaded-docs-list');
            
            if(currUploads.length > 0){
                 docsRow.empty();
                
                for(var i in currUploads){
                    docsRow.append(Plex.inquiries.makeUploadIcon(currUploads[i]));
                }
            }

        });//end ajax
        
       
    });

    /////////////
    $(document).on('click', '.cancel-edit-btn', function(e){

        var el = $(e.target).closest('.edit-actions');
        var pPane =  el.closest('.inquirie_row').find('.sales-student-pane');
        var other = el.closest('.inquirie_row').find('.sales-student-edit-pane');
        var contactPane = el.closest('.inquirie_row').find('.contact-pane-wrapper');

        el.hide();
        other.hide();

        pPane.show();
        pPane.find('.regular-actions').show();   


    });
    /************** end dropdown profile ****************/
    
    /************** start change other college application status ****************/
    $(document).on('click', '.student-profile-also-interested-in .applied-college-status-btn', function(event) {
        event.stopPropagation();

        var options = $(this).siblings('.change-status-options'),
            current_status = $(this).attr('data-status');

        // Do not show status change link to the same current status
        options.children('li').each(function(index, element) {
            var status = $(this).text().trim().toLowerCase();
            if (current_status == status) {
                $(this).hide();
            } else {
                $(this).show();
            }
        });

        if (options.is(':visible')) {
            options.fadeOut(300);
        } else {
            options.fadeIn(300);
        }

    });

    // Clicking outside will untoggle all status change options
    $(document).on('click', '.applied-carousel .your-competition-section', function(event) {
        var status_btns = $('.student-profile-also-interested-in .applied-college-status-btn'),
            options = status_btns.siblings('.change-status-options');

        options.fadeOut(300);
    });

    $(document).on('click', '.student-profile-also-interested-in .change-status-options > li', function(event) {
        event.stopPropagation();

        var inqRow = $(this).closest('.inquirie_row'),
            hashed_id = inqRow.data('hashedid'),
            college_id = $(this).closest('.change-status-options').data('college_id'),
            status = $(this).text();
            formatted_status = status.toLowerCase(),
            parent = $(this).closest('.applied-college-item'),
            options_container = $(this).closest('.change-status-options'),
            status_btn = options_container.siblings('.applied-college-status-btn'),
            college_logo = parent.find('.college-logos-background');


        // Null and unacceptable cases
        if (!hashed_id || !college_id) { return; }
        if (status != 'Accepted' && status != 'Rejected' && status !='Pending') { return; }

        Plex.inquiries.updateCollegeAcceptanceStatus(hashed_id, college_id, formatted_status, function() {
            college_logo.attr('data-status', formatted_status); 
            status_btn.attr('data-status', formatted_status);
            status_btn.html(status);
            options_container.hide();
        });
    });

    /************** end change other college application status ****************/

    /************** start add applied college *******************/

    $(document).on('click', '.college_applied', function(event) {
        event.preventDefault();
        var hashed_id = $(this).data('hashedid');
        var college_id = $(this).data('college_id');
        var parent = $(this).closest('.college_applied');
        Plex.inquiries.addUserAppliedCollege(parent,hashed_id,college_id);

    });

    /************** end add applied college ****************/


    /************** start remove applied college ****************/
    $(document).on('click', '.remove-applied-college-btn', function(event) {
        event.stopPropagation();
        var hashed_id = $(this).closest('.inquirie_row').data('hashedid'),
            college_id = $(this).data('college_id'),
            parent = $(this).closest('.applied-college-item'),
            college_name = parent.find('.college-competitor-name').data('college-name'),
            student_name = $(this).closest('.inquirie_row').find('.student-name').html(),
            student_status = parent.find('.applied-college-status').html() || parent.find('.applied-college-status-btn').html();

        $('#remove-applied-college-confirm').dialog({
            resizable: false,
            height: 'auto',
            width: '400px',
            modal: true,
            autoOpen: false,
            bgiframe: true,
            buttons: {
                'Confirm': function() {
                    Plex.inquiries.removeUserAppliedCollege(parent, hashed_id, college_id);
                },
                'Cancel': function() {
                    $('#remove-applied-college-confirm').dialog("close");
                },
            }
        });

        $('#remove-applied-college-confirm > .removed-college-name').html('<b>School</b>: ' + college_name);
        $('#remove-applied-college-confirm > .removed-student-name').html('<b>Student</b>: ' + student_name);
        $('#remove-applied-college-confirm > .removed-student-status').html('<b>Status</b>: ' + student_status);

        $('#remove-applied-college-confirm').dialog('open');
    });

    /************** end remove applied college ****************/

    $(document).on('click', '.colleges-app-status .app-status-btn:not(.selected)', function(event) {
        event.preventDefault();
        var hashed_id = $(this).closest('.inquirie_row').data('hashedid'),
            parent = $(this).closest('.colleges-app-status');
            college_id = parent.data('college-id'),
            status = $(this).data('status');

        Plex.inquiries.updateCollegeAcceptanceStatus(hashed_id, college_id, status, function() {
            parent.find('.app-status-btn').removeClass('selected');
            parent.find('.app-status-btn[data-status="' + status + '"]').addClass('selected');
        });
    });

});//end of doc ready

Plex.inquiries.removeStudentFromAutoDialer = function(studentID) {
    if (!_.isEmpty(Plex.phonecall.autoDialerPeopleList)) {
        Plex.phonecall.autoDialerPeopleList = _.filter(Plex.phonecall.autoDialerPeopleList, function(person) {
            return person.student_user_id !== studentID;
        });
        
        Plex.phonecall.updateAutoDialerPerson();
    }
}

/***** Update Colleges Acceptance *****/
Plex.inquiries.updateCollegeAcceptanceStatus = function(hashed_id, college_id, status, callback) {
        
    Plex.inquiries.showLoader();

    $.ajax({
        url: '/admin/ajax/saveCollegeAcceptanceStatus',
        type: 'POST',
        data: { hashed_id: hashed_id, college_id: college_id, status: status },
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},

    }).done(function(response) { 
        callback();
        Plex.inquiries.hideLoader();
        topAlert(Plex.inquiries.updatedStudentApplicationStatus);
    }).fail(function(response) {
        topAlert(Plex.inquiries.updatedStudentApplicationStatusFailure);
    });
}

Plex.inquiries.addUserAppliedCollege = function(parent, hashed_id, college_id) {
    
    Plex.inquiries.showLoader();

    $.ajax({
        url: '/admin/inquiries/addUserAppliedCollege',
        type: 'POST',
        data: { hashed_id: hashed_id, college_id: college_id },
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},

    }).done(function(response) {
        Plex.inquiries.hideLoader();
        console.log(parent);        
        $(parent).removeClass('college_applied');
        $(parent).addClass('submitted_college');

    }).fail(function(response) {
        Plex.inquiries.hideLoader();

    });
}

Plex.inquiries.removeUserAppliedCollege = function(parent, hashed_id, college_id) {
    $('#remove-applied-college-confirm').dialog("close");
    
    Plex.inquiries.showLoader();

    $.ajax({
        url: '/admin/inquiries/removeUserAppliedCollege',
        type: 'POST',
        data: { hashed_id: hashed_id, college_id: college_id },
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},

    }).done(function(response) {
        Plex.inquiries.hideLoader();
        parent.remove();

    }).fail(function(response) {
        Plex.inquiries.hideLoader();

    });
}

Plex.inquiries.promoteUserVerified = function(button, buttonArrow, that, rurl, data, selection){
    var prev = '';
    var menu = that.closest('.promote_menu');

    Plex.inquiries.showLoader();

    $.ajax({
        url: rurl,
        type: 'POST',
        data: data,
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    }).done(function(response){ 

// console.log(response);
// console.log(JSON.parse(response));
        // var res = JSON.parse(response);
        // var page = res["page"];
        
        if(response === 'failed')
            topAlert(Plex.inquiries.promoteVerifiedError);
        
        else{

            switch(selection){
                case 'Undo Promote Verified Handshakes':
                case 'Undo Promote Verified Applications':
                    topAlert(Plex.inquiries.promoteUndoSuccess); 
                    
                    // if(page){
                    //     prev =  response.page.split('-').slice(1);   
                     

                    // switch(prev){
                    //     case 'approved':
                    //         prev = 'Handshakes';
                    //         break;
                    //     case 'verified-hs':
                    //         prev = 'Verified Handshakes';
                    //         break; 
                    //     default:
                    //         prev = prev.charAt(0).toUpperCase() + prev.slice(1);
                    //         break;
                    // }
                    // alert(prev);
                    //     Plex.inquiries.moveToTemplate.msg = Plex.inquiries.moveToTemplate.msg + prev;
                    //     topAlert(Plex.inquiries.moveToTemplate);

                    // } 

                    if(!menu.hasClass('promote_menu_small')){

                        button.find('.promote-text').text('Promote to');
                        button.removeClass('actionbar-btn-updated');
                        button.removeClass('actionbar-btn-active');
                        button.addClass('actionbar-btn-notactive');
                        buttonArrow.removeClass('promote-arrow-active');
                        buttonArrow.addClass('promote-arrow-notactive');
                    }


                    if(selection === 'Undo Promote Verified Handshakes'){
                        //must update number to right on left nav
                        var cnt = parseInt($('.verifiedHsCnt-total').text()) - 1;
                        if(cnt >= 0)
                            $('.verifiedHsCnt-total').text(cnt);
                    }else{
                        //must update number to right on left nav
                        var cnt = parseInt($('.verifiedHsCnt-total').text()) - 1;
                        if(cnt >= 0)
                            $('.verifiedHsCnt-total').text(cnt);
                    }

                    break;

                case 'Verified Handshakes':
                    topAlert(Plex.inquiries.promoteVerifiedHsSuccess);
                    Plex.inquiries.verifiedButtonChange(button, buttonArrow, selection);
                    
                    
                    //must update number to right on left nav
                    var cnt = 1 + parseInt($('.verifiedHsCnt-total').text());
                    $('.verifiedHsCnt-total').text(cnt);
                  
                    break;

                case 'Verified Prescreen':
                    topAlert(Plex.inquiries.promoteVerifiedPSuccess);
                    Plex.inquiries.verifiedButtonChange(button, buttonArrow, selection);
                     
                    //must update number to right on left nav
                    var cnt = 1 + parseInt($('.verifiedPCnt-total').text());
                    $('.verifiedPCnt-total').text(cnt);
                  
                    break;

                case 'Verified Applications':
                    topAlert(Plex.inquiries.promoteVerifiedASuccess);
                    Plex.inquiries.verifiedButtonChange(button, buttonArrow, selection);
                    
                    //must update number to right on left nav
                    var cnt = 1 + parseInt($('.verifiedACnt-total').text());
                    $('.verifiedACnt-total').text(cnt);
                  
                    break;

                case 'Handshakes':
                    topAlert(Plex.inquiries.promoteHsSuccess);
                    Plex.inquiries.verifiedButtonChange(button, buttonArrow, selection);
                    break;

                case 'Converted':
                    topAlert(Plex.inquiries.promoteConvertedSuccess);
                    Plex.inquiries.verifiedButtonChange(button, buttonArrow, selection);
                    break;

                default:
                    break;              
            }

             //remove row
            that.closest('.inquirie_row').remove();
        }

        menu.hide();
        Plex.inquiries.hideLoader();

    });

};


Plex.inquiries.verifiedButtonChange = function(button, buttonArrow, selection){

    button.find('.promote-text').text(selection);
    button.removeClass('actionbar-btn-active');
    button.addClass('actionbar-btn-updated');
    buttonArrow.addClass('promote-arrow-active');
    buttonArrow.removeClass('promote-arrow-notactive');
}; 

Plex.inquiries.ifRedirectBackFromExport = function(){
    var processing_modal = $('#export-processing-modal');

    if( processing_modal.length === 1 && processing_modal.data('processing-export') ){
        processing_modal.foundation('reveal', 'open');
    }
};


Plex.inquiries.initNewMatchedOwl = function(){
    //get all unset owls
    var unsetowls = $('.student-profile-matched[data-isset="0"]');
    // console.log('unset: ', unsetowls);

    //if there are any new unset carousels, then set them, otherwise there are no new results so don't need to do anything
    if( unsetowls.length > 0 ){
        //add unique class name
        unsetowls.addClass('owl-' + Plex.inquiries.uniqueMatched);

        //get new owls
        var owl = $('.student-profile-matched.owl-'+Plex.inquiries.uniqueMatched);

        //set owlcarousel to new owl
        owl.owlCarousel({
            autoPlay: false,
            items : 4,
            itemsDesktop : [1199,3],
            itemsDesktopSmall : [979,3],
            itemsTablet : [768, 3],
            itemsMobile : [479, 1],
            pagination : false,
            beforeMove : function(elem){
                var itemsVisible = this.visibleItems;
                var totalItems = this.itemsAmount;
                var itemsAllowed = this.options.items;

                Plex.inquiries.hideCompetitionCarouselArrows(totalItems, itemsAllowed);
            }
        });

        //increment uniqueMatched num
        Plex.inquiries.uniqueMatched++;
        //make unset owl set
        unsetowls.attr('data-isset', 1);

        //click event for competition carousel arrow clicks
        $('.competitor-carousel-arrow').click(function(){
            Plex.inquiries.moveCompetitionCarousel(owl, this);
        });
    }
};


Plex.inquiries.initNewOwl = function(){
    //get all unset owls
    var unsetowls = $('.student-profile-also-interested-in[data-isset="0"]');

    //if there are any new unset carousels, then set them, otherwise there are no new results so don't need to do anything
    if( unsetowls.length > 0 ){
        //add unique class name
        unsetowls.addClass('owl-' + Plex.inquiries.unique);

        //get new owls
        var owl = $('.student-profile-also-interested-in.owl-'+Plex.inquiries.unique);

        //set owlcarousel to new owl
        owl.owlCarousel({
            autoPlay: false,
            items : 4,
            itemsDesktop : [1199,3],
            itemsDesktopSmall : [979,3],
            itemsTablet : [768, 3],
            itemsMobile : [479, 1],
            pagination : false,
            beforeMove : function(elem){
                var itemsVisible = this.visibleItems;
                var totalItems = this.itemsAmount;
                var itemsAllowed = this.options.items;

                Plex.inquiries.hideCompetitionCarouselArrows(totalItems, itemsAllowed);
            }
        });

        //increment unique num
        Plex.inquiries.unique++;
        //make unset owl set
        unsetowls.attr('data-isset', 1);

        //click event for competition carousel arrow clicks
        $('.competitor-carousel-arrow').click(function(){
            Plex.inquiries.moveCompetitionCarousel(owl, this);
        });
    }
};


Plex.inquiries.initOwlCarousel = function() {
    var student_owl = $('.student-profile-also-interested-in');
    student_owl.each(function(index, elem) {
        console.log('owl: ', elem);
        if($(this).find('.owl-wrapper-outer').length == 0) {
            $(this).owlCarousel({
                autoPlay: false,
                items : 4,
                itemsDesktop : [1199,3],
                itemsDesktopSmall : [979,3],
                itemsTablet : [768, 3],
                itemsMobile : [479, 1],
                pagination : false,
                beforeMove : function(elem){
                    var itemsVisible = this.visibleItems;
                    var totalItems = this.itemsAmount;
                    var itemsAllowed = this.options.items;

                    Plex.inquiries.hideCompetitionCarouselArrows(totalItems, itemsAllowed);
                }
            });
        }
    });

    $(document).foundation('interchange', 'reflow');

    //click event for competition carousel arrow clicks
    $('.competitor-carousel-arrow').click(function(){
        Plex.inquiries.moveCompetitionCarousel(student_owl, this);
    });
}

//init section obj start
Plex.inquiries.initSections = function(){
    var sections = $('li.search-tab'), tab = null;

    Plex.inquiries.sections = new SearchSectionList();

    $.each(sections, function(val, index){
        tab = $(this).data('search-tab');
        Plex.inquiries.sections.addSection( new SearchSection(tab) );
    });
}

var SearchSection = function SearchSection(name){
    this.name = name;
    this.changed = !1;
    // this.locked = !1;
}

SearchSection.prototype.hasChanged = function(){
    this.changed = !0;
    Plex.inquiries.sections.updateView();
}

SearchSection.prototype.reset = function(){
    this.changed = !1;
    Plex.inquiries.sections.updateView();
}

var SearchSectionList = function SearchSectionList(){
    this.list = [];
}

SearchSectionList.prototype.addSection = function(section){
    this.list.push(section);
}

SearchSectionList.prototype.updateView = function(){
    var elem = null;
    _.each(this.list, function(obj, index, arr){
        elem = $('li.search-tab[data-search-tab="'+obj.name+'"] .change-icon');
        if( obj.changed ) elem.removeClass('hide');
        else if( !obj.changed ){
            if( elem.is(':visible') ) elem.addClass('hide');
        }
    });
}

SearchSectionList.prototype.resetAll = function(){
    _.each(this.list, function(obj){
        if( obj.changed ) obj.reset();
    });
}

SearchSectionList.prototype.getSection = function(section_name){
    return _.findWhere(this.list, {name: section_name});
}

SearchSectionList.prototype.getChangedSections = function(bool){
    return _.where(this.list, {changed: bool});
}
// -- init section obj end

// -- update search results
$(document).on('click', '.update-search-btn', function(e){
    e.preventDefault();
    Plex.inquiries.updateSearchResults($(this));
});

// -- clear filter
$(document).on('click', '.clear-search-btn', function(e){
    e.preventDefault();
    Plex.inquiries.clearFilter();
});

$(document).on('click', '.uploads-filter-select-all-btn', function(event){
    Plex.inquiries.toggleUploadsFilterSelectAll(event);
});

// -- run filter audience
Plex.inquiries.updateSearchResults = function(elem) {
    var current_page = $('.update-search-btn').parents('body').attr('id');
    var route = null;
    var form = elem.closest('form');
    var formdata = new FormData(form[0]);

    // this is an ajax call, but it will reset sorting and display
    formdata.append('init', '1');
    if (current_page) {
        route = '/' + Plex.inquiries.adminType + '/inquiries/updateSearchResults/' + current_page;
    } else {
        route = '/' + Plex.inquiries.adminType + '/inquiries/updateSearchResults';
    }

    var formIs = '';
    var hasResults = 1;

    formIs = Plex.inquiries.validateEntireForm();

    if( formIs != 'clean' ) {
        if( Plex.inquiries.activeTab !== formIs )
            $('li[data-search-tab="'+formIs+'"] > a').trigger('click');
    } else {
        //start ajax loader
        Plex.inquiries.showLoader();

        // close filter options
        $('.filter-result a.ms-btns').trigger('click');

        $.ajax({
            url: route,
            type: 'POST',
            data: formdata,
            contentType: false,
            processData: false,
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        }).done(function(data) {
            var current_viewing = null;
            var total_results = null;

            var parseHTML = document.createElement('html');
            parseHTML.innerHTML = data;

            var hasResults = $(parseHTML).find('.hasResults');
            var filteredResults = hasResults.data('more-results');

            if (!_.isEmpty(filteredResults) && Plex.phonecall.autoDialerPeopleList) {
                var unfilteredAutoDialerList = filteredResults;
            
                Plex.phonecall.autoDialerPeopleList = _.filter(unfilteredAutoDialerList, function(person) {
                    return person.phone && person.phone != ' ' && Plex.phonecall.autoDialerBlackList.indexOf(person.student_user_id) === -1;
                });

                Plex.phonecall.updateAutoDialerPerson();
            }

            //hide loader
            Plex.inquiries.hideLoader();

            // is_reset is already be 1
            $('.each-inquirie-container').html('');
            $('.each-inquirie-container').html(data);
            $('.each-inquirie-container').append('<div class="row showResultsBar"><div class="column small-12 medium-4 large-4 showResults"></div><div class="column small-12 medium-8 large-8 load-more text-center"></div></div>');
            Plex.inquiries.injectLoadMoreButton();

            current_viewing = $('.hasResults').last().data('current-viewing');
            total_results = $('.hasResults').last().data('total-results');
            //check if these are the last results
            hasResults = $('.hasResults').last().data('last-results');
            Plex.inquiries.hasResultsCheck(hasResults);

            // $('.each-inquirie-container .showResults').html(Plex.inquiries.injectResults(current_viewing, total_results));
        
            $(elem).closest('#filter-options').hide();
            Plex.inquiries.switchIcon($('a.ms-btns.filter-audience'));

        });
    }
}




Plex.inquiries.clearFilter = function() {
    //reset Start Date
    $('select#startterm').prop('value', '');
    $('select#startyr').prop('value', '');
    //reset financial
    $('select#financial').prop('value', '');
    //reset school type
    $('select#schooltype').prop('value', '');
    //reset location, majors, demo ethnicity, and demo religion
    $('.select-container .tag-list').html('');
    $('input#country_all, input#department_all, input#ethnic_all, input#religion_all, input#schooltype_all, input#financial_all, input#startyr_all, input#startterm_both, input#name_all').trigger('click');
    //reset scores and demographic age text fields
    $('input[data-type="text"]').val('').trigger('blur');
    //reset demographic gender to all
    $('select#s_gender').val('all').trigger('change');
    //reset inMilitary select field to default
    $('select#s_inMilitary, select#s_militaryAffiliation').val('').trigger('change');
    //reset Uploads, Education level, Desired Degree - all section with checkboxes only - reset to checked
    $('input[data-type="checkbox"]').prop('checked', true);
    //reset Profile Completion
    $('select#profile_percent').prop('value', '0');
    //reset applied and enrolled filter
    $('input#applied-filter').prop('checked', false);
    $('input#enrolled-filter').prop('checked', false);
    //close all filter boxes
    $('li.search-tab a.active').trigger('click');

    Plex.inquiries.tags.length = 0;
    // Plex.inquiries.updateFilterCrumbView();
    Plex.inquiries.sections.resetAll();

    $('.cleared-msg').slideDown(250);
    setInterval(function(){
        $('.cleared-msg').slideUp(250);
    }, 3000);

    var currentPage = $('.each-inquirie-container').data('page-type');
    if(currentPage) {
        currentPage = currentPage.split('-');
    }
    var adminType = currentPage[0];
    var page = currentPage[1];
    if(page == 'inquiries')
        window.location.href = '/'+ adminType + '/' + page;
    else
        window.location.href = '/'+ adminType + '/inquiries/' + page;
}

Plex.inquiries.toggleUploadsFilterSelectAll = function(event) {
    event.preventDefault();

    var button = $(event.target),
        radios = button.parents('.component.uploads').find('.form-field'),
        belongsTo = $(button).closest('li.search-tab').data('search-tab'),
        section_obj = Plex.inquiries.sections.getSection(belongsTo),
        currentPage = $('.each-inquirie-container').data('page-type');

    radios.each(function(index, radio) {
        if (button.hasClass('select-all'))
            $(this).prop('checked', true);
        else
            $(this).prop('checked', false);
        
        $(this).trigger('change');
    });

    if (button.hasClass('select-all')) {
        button.removeClass('select-all');
        button.addClass('deselect-all');
    } else {
        button.removeClass('deselect-all');
        button.addClass('select-all');
    }

    if (section_obj && !section_obj.changed) 
        section_obj.hasChanged();
}

Plex.inquiries.initTags = function(data){
    var name = null, prev_key, filter_obj = {}, tabName = '';

    //clear filter before adding new filter
    Plex.inquiries.clearFilter();
    Plex.inquiries.tags.length = 0;

    //save data globally
    Plex.inquiries.initData = data;

    $.each(data, function(key, value){
        name = key.split('_');

        for(var i = 0; i < name.length; i++ ){
            if( name[i].toLowerCase().indexOf('gpa') > -1 ){
                name[0] = 'gpa';
                break;
            }else if( name[i].toLowerCase().indexOf('scores') > -1 ){
                name[0] = 'scores';
                break;
            }else if( name[i].toLowerCase().indexOf('ethnic') > -1 ){
                name[0] = 'ethnic';
            }
        }

        switch( name[0] ){
            case 'startdate':
            case 'schooltype':
            case 'financial':
            case 'country':
            case 'state':
            case 'city':
            case 'department':
            case 'major':
            case 'religion':
            case 'ethnic':
                if( !prev_key ){
                    prev_key = name.join('_');
                    filter_obj.name = prev_key;
                    filter_obj.val = value;
                }else{
                    //use the key to inject value
                    filter_obj.tags = value;
                    if( filter_obj.val !== 'all' )
                        Plex.inquiries.initLocation(filter_obj);

                    prev_key = null;
                }
                break;
            case 'gpa':
            case 'scores':
            case 'age':
                Plex.inquiries.initScores(key, value);
                break;
            case 'uploads':
            case 'education':
            case 'degree':
                tabName = Plex.inquiries.getTabName(name[0]);
                //first, uncheck all checkboxes for each component, then add ones we have values for
                $('.component.'+tabName).find('input[type="checkbox"]').prop('checked', false);
                if( value.length > 0 )
                    Plex.inquiries.initUploadsEducationDegree(value);
                break;
            case 'date':
                //if date isn't empty, init date
                if( value )
                    Plex.inquiries.initDate(key, value);
                break;
            default:
                //if value isn't all, init Gender/militaryAffiliation
                if( value !== 'all' )
                    Plex.inquiries.initGenderMilitary(key, value);
            break;
        }
    });

}

Plex.inquiries.initCity = function(){
    if( !Plex.inquiries.initData || !Plex.inquiries.initData.city ) return;

    _.each(Plex.inquiries.initData.city, function(value){
        $('#s_cities').val(value).trigger('change');
    });

    Plex.inquiries.cityInitDone = true;
}

Plex.inquiries.initMajor = function(){ 
    if( !Plex.inquiries.initData || !Plex.inquiries.initData.major ) return;

    console.log('majors in initMajor: ', Plex.inquiries.initData.major)
    _.each(Plex.inquiries.initData.major, function(value){
        $('#s_majors').val(value).trigger('change');
    });

    Plex.inquiries.majorInitDone = true;
}

Plex.inquiries.getTabName = function(name){
    if( name === 'degree' )
        return 'desiredDegree';
    else if( name === 'education' )
        return name + 'Level';
    else
        return name;
}

Plex.inquiries.initDate = function(key, value){
    var to = '', from = '', date_split = null;
    date_split = value.split(' ');

    $('input[name="'+key+'"]').val(value);
    $('input[name="daterangepicker_start"]').val(date_split[0]);
    $('input[name="daterangepicker_end"]').val(date_split[2]);
    $('.applyBtn').trigger('click');
}

Plex.inquiries.initGenderMilitary = function(key, value){
    $('select[name="'+key+'"]').val(value).trigger('change');
}

Plex.inquiries.initUploadsEducationDegree = function(arr){
    if( !$.isArray(arr) ) arr = [arr];
    if( arr.length > 0 ){
        _.each(arr, function(value, index, arr){
            //check all the boxes that we have values for
            $('input[type="checkbox"][value="'+value+'"]').prop('checked', true).trigger('change');
        });
    }
}

Plex.inquiries.initScores = function(key, arr){
    $('input[name="'+key+'[]"][placeholder="Min"]').val(arr[0]).trigger('blur');
    $('input[name="'+key+'[]"][placeholder="Max"]').val(arr[1]).trigger('blur');;
}

Plex.inquiries.initLocation = function(obj){
    var elem = $('input[name="'+obj.name+'"][value="'+obj.val+'"]'),
        select_field = elem.closest('.component').find('select'),
        section = elem.closest('li.search-tab').data('search-tab'),
        val = '';

    Plex.inquiries.activeTab = section;
    elem.prop('checked', true).trigger('change');

    if( obj.tags.length === 1 ){
        val = obj.tags[0] === 'Select...' ? '' : obj.tags[0];
        select_field.val(val).trigger('change');
    }else{
        _.each(obj.tags, function(value, index, arr){
            select_field.val(value).trigger('change');
        });
    }

}

// -- validation by section
//validate entire form; return tab that has invalid input; else return 'clean'
Plex.inquiries.validateEntireForm = function(){
    var invalid_page = 'clean';
    var valid = false;
    //var sections = ['scores', 'uploads', 'demographic', 'educationLevel', 'desiredDegree'];
    var sections = ['scores', 'demographic', 'educationLevel', 'desiredDegree'];
    var validator = null;
    var runFunction;

    for( var i = 0; i < sections.length; i++){
        validator = sections[i] + 'IsValid';
        runFunction = Plex.inquiries[validator];
        valid = runFunction();

        if( !valid ){
            invalid_page = sections[i];
            break;
        }
    }

    return invalid_page;
};

//validate min scores is not greater than max scores
Plex.inquiries.scoresIsValid = function(){
    var component = $('.component.scores');
    var fields = component.find('input[type="number"]');
    var errorElem = component.parent().find('.error-msg');
    var valid = true;
    var tempMin = 0;

    $.each(fields, function(i){
        var _this = $(this);
        var val = parseFloat(_this.val());

        if( i%2 === 0 ){
            tempMin = val;
        }else{
            if( (_.isNumber(val) && _.isNumber(tempMin) ) && tempMin >= val ){
                valid = false;
            }
        }
    });

    //toggle error message
    Plex.inquiries.toggleErrorMsg(valid, errorElem);

    return valid;
};

//validate uploads has at least one checked
Plex.inquiries.uploadsIsValid = function(){
    var component = $('.component.uploads');
    var fields = component.find('input[type="checkbox"]');
    var errorElem = component.parent().find('.error-msg');
    var valid = false;

    valid = Plex.inquiries.atLeastOneChecked(fields);
    //toggle error message
    Plex.inquiries.toggleErrorMsg(valid, errorElem);

    return valid;
};

//validate demographic
Plex.inquiries.demographicIsValid = function(){
    var component = $('.component.age');
    var fields = component.find('input[type="number"]');
    var errorElem = component.parent().find('.error-msg');
    var min = parseInt($(fields[0]).val());
    var max = parseInt($(fields[1]).val());
    var valid = true;

    if( min >= max )
        valid = false;

    //toggle error message
    Plex.inquiries.toggleErrorMsg(valid, errorElem);

    return valid;
};

//validate that at least hs or college is checked
Plex.inquiries.educationLevelIsValid = function(){
    var valid = false;
    var errorElem = $('.component.educationLevel').parent().find('.error-msg');

    if( $('#education_hs').is(':checked') || $('#education_college').is(':checked') )
        valid = true;
    else
        valid = false;

    //toggle error message
    Plex.inquiries.toggleErrorMsg(valid, errorElem);

    return valid;
};

//validate that at least one degree is checked
Plex.inquiries.desiredDegreeIsValid = function(){
    var component = $('.component.desiredDegree');
    var form_fields = component.find('input[type="checkbox"]');
    var errorElem = component.parent().find('.error-msg');
    var valid = false;

    //atLeastOneChecked will return true or false and then toggle error msg if there is an error or not
    valid = Plex.inquiries.atLeastOneChecked(form_fields);
    Plex.inquiries.toggleErrorMsg(valid, errorElem);

    return valid;
};

//returns true if at least one checkbox is checked, else returns false
Plex.inquiries.atLeastOneChecked = function(fields){
    var oneChecked = false;

    $.each(fields, function(){
        if( $(this).is(':checked') ){
            oneChecked = true;
            return false;
        }
    });

    return oneChecked;
};

//toggles error msg based on validity
Plex.inquiries.toggleErrorMsg = function(valid, errorElem){
    if( !valid )
        errorElem.removeClass('hidden');
    else
        errorElem.addClass('hidden');
};
// -- validation by section

// -- tags
//save tags in global array
Plex.inquiries.saveTag = function(belongs, val, type, text, option){
    var tag = {};
    tag.belongs_to = belongs;
    tag.val = val;
    tag.component = type;
    tag.text = text;
    tag.option = option || null;
    Plex.inquiries.tags.push(tag);
}

//update tag based on prop
Plex.inquiries.updateTag = function(tag, prop, val){
    var update_this_tag = null;

    _.each(tag, function(obj, index, arr){
        update_this_tag = _.findWhere(Plex.inquiries.tags, obj);
        update_this_tag[prop] = val;
    });
}

//remove tags from global array
Plex.inquiries.removeTag = function(tag_val){
    tag_val = ''+tag_val;
    Plex.inquiries.tags = _.reject(Plex.inquiries.tags, {val: tag_val});
}
Plex.inquiries.removeTagAsNumber = function(tag_val){
    Plex.inquiries.tags = _.reject(Plex.inquiries.tags, {val: +tag_val});
}

//remove multiple tags by section type
Plex.inquiries.removeTagBySection = function(tag_type){
    Plex.inquiries.tags = _.reject(Plex.inquiries.tags, {belongs_to: tag_type});
}

//remove multiple tags by component type
Plex.inquiries.removeTagByComponent = function(tag_type){
   Plex.inquiries.tags = _.reject(Plex.inquiries.tags, {component: tag_type});
}

Plex.inquiries.removeCrumb = function(section, comp, valu){
    Plex.inquiries.tags = _.reject(Plex.inquiries.tags, {val: valu});
}

//get tags by component
Plex.inquiries.getTagsByComponent = function(type){
    return _.filter(Plex.inquiries.tags, {component: type});
}

//get tags by certain prop
Plex.inquiries.getTags = function(prop, val){
    var searchObj = {};
    searchObj[prop] = val;
    return _.where(Plex.inquiries.tags, searchObj);
}

//no duplicate tags
Plex.inquiries.findTag = function(obj_array, obj_val, obj_type){
    var result = null;
    result = _.findWhere(obj_array, {val: obj_val, component: obj_type});
    return result === undefined ? false : true;
}

//filter tags by type and inject html into appropriate tag list
Plex.inquiries.updateTagListView = function(elem, type){
    var tmp_arr = _.filter(Plex.inquiries.tags, {component: type});
    $(elem).parents('.select-container').find('.tag-list').html( Plex.inquiries.buildFilterTags(tmp_arr) );
}

//update view
Plex.inquiries.makeTags = function(elem, type){
    var tmp_arr = _.filter(Plex.inquiries.tags, {component: type});
    $(elem).closest('.search-filter-form').find('.select-container .tag-list').html( Plex.inquiries.buildFilterTags(tmp_arr, true) );
}

//build tag html to display on the page
Plex.inquiries.buildFilterTags = function(tag_list, useText){
    var html_tags = '', txt = '';

    $(tag_list).each(function(tag){
        txt = useText ? this.text : this.val;
        html_tags += '<div class="left tag" data-tag-val="'+this.val+'" data-component="'+this.component+'" data-belongsto="'+this.belongs_to+'">';
        
        //if financial -- we want to remove the ability to remove tags from this list
        //and only allow users to change list through dropdown
        if(this.component === 'financial'){
            html_tags +=  this.text;
        }else if(this.component === 'hasApplied'){
            html_tags +=  this.text + '<span class="remove-tag"> &times; </span>';
        }else{
            html_tags +=  txt + '<span class="remove-tag"> &times; </span>';
        }
        html_tags +=     '<input type="hidden" name="'+this.component+'[]" value="'+txt+'" />'
        html_tags += '</div>';
    });

    return html_tags;
}

Plex.inquiries.alreadyHaveTag = function(comp, txt){
    return _.where(Plex.inquiries.tags, {component: comp, text: txt});
}

Plex.inquiries.tagExists = function(comp){
    return _.findWhere(Plex.inquiries.tags, {component: comp});
}

// -- end tags



// -- radio btn form field event handler
$(document).on('change', 'input[type="radio"][data-type="radio"].form-field', function(){
    var _this = $(this), val = _this.val(),
        text = _this.next().text(), option = null,
        section = _this.closest('li.search-tab').data('search-tab'), already_have_tag = null,
        error_msg = _this.parent().find('.error'), section_obj = null, validator = false;

    if( section === 'schooltype' ){
        already_have_tag = Plex.inquiries.tagExists(section);

        if( !already_have_tag ){
            Plex.inquiries.saveTag(section, val, section, text, option);
        }else{
            Plex.inquiries.updateTag(already_have_tag, 'val', val);
            Plex.inquiries.updateTag(already_have_tag, 'text', text);
        }

        Plex.inquiries.makeTags(_this, section);
    }
});
// -- radio btn form field event handler



// -- text input field event trigger
$(document).on('blur', 'input[type="number"][data-type="text"].form-field', function(){
    var _this = $(this), component = _this.closest('.row').find('.s-label').text().split(''),
        component = _.without(component, component.pop()).join(''),
        belongsTo = _this.closest('li.search-tab').data('search-tab'),
        text = _this.attr('placeholder').toLowerCase(), option = _this.attr('pattern'),
        section = _this.closest('li.search-tab').data('search-tab'), already_have_tag = null,
        error_msg = _this.parent().find('.error'), section_obj = null, validator = false;

    //check if score is valid
    if( !error_msg.is(':visible') ){
        //if input has a value and no error msg visible, then save tag
        if( _this.val() ){
    //         //check if tag is already created for this component
            already_have_tag = Plex.inquiries.alreadyHaveTag(component, text);
            if( already_have_tag.length === 0 ){
                Plex.inquiries.saveTag(section, _this.val(), component, text, option);
            }else{
                Plex.inquiries.updateTag(already_have_tag, 'val', _this.val());
            }
        }else{
            already_have_tag = Plex.inquiries.alreadyHaveTag(component, text);
            if( already_have_tag.length > 0 ){

                Plex.inquiries.removeTag(already_have_tag[0].val);
            }
        }
    }

    $('.component.scores').find("input").each( function(){
        if($(this).val() != "")
            validator = true;
    });

    section_obj = Plex.inquiries.sections.getSection(belongsTo);

    if(!validator) {
        if( section_obj ) section_obj.reset();
    }

    if( section_obj && !section_obj.changed ) section_obj.hasChanged();

    // Plex.inquiries.updateFilterCrumbView();
});

$(document).on('change', 'input[data-type="checkbox"]', function(){
    var _this = $(this), section = Plex.inquiries.getSectionName(_this), component = section, belongsTo = _this.closest('li.search-tab').data('search-tab'),
        val = _this.val(), option = _this.is(':checked') ? 'include' : 'exclude', text = _this.parent().find('label').text();

    //if checked, add tag, else remove it
    if( _this.is(':checked') ){
        Plex.inquiries.saveTag(section, val, component, text, option);
    }else{
        Plex.inquiries.removeCrumb(section, component, val);
    }

    section_obj = Plex.inquiries.sections.getSection(belongsTo);
    if( section_obj && !section_obj.changed ) section_obj.hasChanged();
    // Plex.inquiries.updateFilterCrumbView();
});

Plex.inquiries.getSectionName = function(elem){
    return elem.closest('li.search-tab').data('search-tab');
}
// -- end text input filed event trigger

// -- component toggle
$(document).on('click', 'input.add-name', function() {
    var _this = $(this).prev('div').find('input'), val_text = _this.val(),
        belongsTo = _this.closest('li.search-tab').data('search-tab'),
        component_name = _this.attr('name'), duplicateFound = false, demo_tag = null,
        option = _this.closest('.component').find('input[type="radio"]:checked').val(),
        val = '', prop = '', section_obj = null;

    demo_tag = Plex.inquiries.getTags('component', component_name);

    // if there is an input name text
    if(option == 'all') {
        Plex.inquiries.removeTagByComponent(component_name);
    } else {
        // include or exclude
        if(val_text) {
            // find duplicate
            duplicateFound = Plex.inquiries.findTag(Plex.inquiries.tags, val_text, component_name);
            if(!duplicateFound) {
                Plex.inquiries.saveTag(belongsTo, val_text, _this.attr('name'), val_text, option);
                Plex.inquiries.updateTagListView(_this, component_name);
            }
        }
    }

    section_obj = Plex.inquiries.sections.getSection(belongsTo);
    if( section_obj && !section_obj.changed ) section_obj.hasChanged();

    _this.prop('value', '');

});

$(document).on('change', 'select[data-type="select"]:not(.savedFilters-class)', function(){
    var _this = $(this),
        val_text = $('option[value="'+_this.val()+'"]', _this).text(),
        belongsTo = _this.closest('li.search-tab').data('search-tab'),
        component_name = _this.attr('name'), duplicateFound = false, demo_tag = null,
        option = _this.closest('.component').find('input[type="radio"]:checked').val(),
        val = '', prop = '', state = '', section_obj = null;

    if( component_name === 'city' && !Plex.inquiries.cityInitDone ){
        Plex.inquiries.populateCityBasedOnState($('#s_states').val(), true);
    }else if( component_name === 'major' && !Plex.inquiries.majorInitDone ){
        Plex.inquiries.populateMajorBasedOnDepartment($('#s_depts').val(), true);
    }

    if( Plex.inquiries.activeTab === 'location' ||  Plex.inquiries.activeTab === 'major' ||
        Plex.inquiries.activeTab === 'startdate' ||  Plex.inquiries.activeTab === 'schooltype' ||
        Plex.inquiries.activeTab === 'financial' )
        Plex.inquiries.toggleComponents(_this);

    if( component_name === 'gender' ){
        val = _this.val();
        prop = 'val';
    }else{
        val = val_text;
        prop = 'text';
    }


    //if value is not empty or equal to Select..., then proceed to check if this tag already exists, if not, save it
    if( _this.val() && val_text !== 'Select...' ){
        if( (Plex.inquiries.activeTab === 'demographic' && component_name === 'gender') ||
            (Plex.inquiries.activeTab === 'militaryAffiliation' && component_name === 'inMilitary') ||
            (Plex.inquiries.activeTab === 'profileCompletion') ){

            demo_tag = Plex.inquiries.getTags('component', component_name);

            if( val === 'all' ){
                Plex.inquiries.removeTagByComponent(component_name);
            }else{
                if( demo_tag.length > 0 ) Plex.inquiries.updateTag(demo_tag, prop, val);
                else Plex.inquiries.saveTag( belongsTo, _this.val(), _this.attr('name'), val_text, option );
            }

        }
        else if(Plex.inquiries.activeTab === 'financial'){
 
            //clear tag list to create new one
            //Plex.inquiries.tags.length = 0;
            Plex.inquiries.removeTagByComponent(component_name);

            //save tag for this value and all above it
            for(var i = $.inArray(val.trim(), Plex.inquiries.ranges_formatted); i < Plex.inquiries.ranges.length; i++){
                Plex.inquiries.saveTag( belongsTo, Plex.inquiries.ranges[i], _this.attr('name'), Plex.inquiries.ranges_formatted[i], option );             
            }
    
        }
        else{
            // come back
            duplicateFound = Plex.inquiries.findTag(Plex.inquiries.tags, _this.val(), component_name);
            if( !duplicateFound && val !== 'all' && _this.val() ){
                Plex.inquiries.saveTag( belongsTo, _this.val(), _this.attr('name'), val_text, option );
                Plex.inquiries.updateTagListView(_this, component_name);
               
            }
        }
    }else{      
        if( Plex.inquiries.activeTab === 'demographic' || 
            Plex.inquiries.activeTab === 'militaryAffiliation' || 
            Plex.inquiries.activeTab === 'profileCompletion' ||
            Plex.inquiries.activeTab === 'financial'){
                Plex.inquiries.removeTagByComponent(component_name);
        }
    }

    section_obj = Plex.inquiries.sections.getSection(belongsTo);
    if( section_obj && !section_obj.changed ) section_obj.hasChanged();

    Plex.inquiries.updateTagListView(_this, component_name);
});

// remove tag
$(document).on('click', '.tag-list .remove-tag', function(){
    var _this = $(this).parent(),
        val = _this.data('tag-val'),
        select_elem = _this.closest('.select-container').find('select');

    // update tags list
    if( _this.closest('.tag-list').hasClass('for-applied') ) Plex.inquiries.removeTagAsNumber(val);
    else Plex.inquiries.removeTag(val);

    //remove from view
    _this.remove();

    //check if any components need to be toggled depending on tag removed
    Plex.inquiries.onTagRemove(_this, select_elem);
});

Plex.inquiries.onTagRemove = function(tag, container){
    var val = tag.data('tag-val'),
        current_component_tags = null,
        component_name = tag.data('component');

    //get the current components tags
    current_component_tags = Plex.inquiries.getTagsByComponent(component_name);

    //if there are no more tags for this component, trigger click, otherwise do nothing
    if( _.isEmpty(current_component_tags) ){
        $('.component.'+component_name+' input[value="all"]').trigger('click');
    }else if( val === 'United States' ){
        container.val('');
        Plex.inquiries.toggleComponents( container );
    }
}
//toggle components based on select field value
Plex.inquiries.toggleComponents = function(elem){
    var dependency = elem.closest('.component').data('dependency');
    var search_form = elem.closest('.search-filter-form');
    var name = elem.attr('name');

    if( typeof dependency !== 'undefined' ){
        switch( name ){
            case 'country':
                if( elem.val() === 'United States' || Plex.inquiries.findTag(Plex.inquiries.tags, 'United States', 'country') )
                    search_form.find('.component.'+dependency).removeClass('hidden');
                else
                    search_form.find('.component:not(.'+name+')').addClass('hidden');
                break;
            default:
                if( elem.val() !== '' )
                    search_form.find('.component.'+dependency).removeClass('hidden');
                else
                    search_form.find('.component.'+dependency).addClass('hidden');
                break;
        }
    }
}
// -- component toggle

// -- all/include/exclude toggle
$(document).on('change', '.search-sidenav input[type="radio"]', function(){
    var component_name = null, tmp, _this = $(this);

    if( Plex.inquiries.activeTab === 'location' ||  Plex.inquiries.activeTab === 'major' ||
        Plex.inquiries.activeTab === 'demographic' || Plex.inquiries.activeTab === 'startdate' ||
        Plex.inquiries.activeTab === 'name' || Plex.inquiries.activeTab === 'schooltype' ||
        Plex.inquiries.activeTab === 'financial' ){
        Plex.inquiries.toggleSelectContainer( _this );

        //get component name, then find tags by component name
        component_name = _this.attr('name').split('_')[0];
        tagsFound = Plex.inquiries.getTags('component', component_name);

        //if any found, update them with new radio val
        if( tagsFound.length > 0 ){

            //update crumb tags data, then update crumb tag view
            Plex.inquiries.updateTag(tagsFound, 'option', $(this).val());
            // Plex.inquiries.updateFilterCrumbView();
        }

    }
});


// Remove upload attachment button
$(document).on('click', '.remove-upload-btn', function(event) {
    var that = $(this),
        inqRow = $(this).parents('.inquirie_row');
        hashed_user_id = inqRow.data('hashedid'),
        transcript_id = $(this).data('transcript-id'),
        doc_type = $(this).data('doc-type');

    Plex.inquiries.showLoader();

    // console.log(hashed_user_id, transcript_id);
    $.ajax({
        url: '/admin/inquiries/removeTranscriptAttachment',
        type: 'POST',
        data: {
            hashed_user_id: hashed_user_id, 
            transcript_id: transcript_id
        },
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function(result) {
        
        Plex.inquiries.hideLoader();

        if (result === 'success') {
            topAlert(Plex.inquiries.fileRemoveSuccessMsg);

            if (doc_type == 'prescreen_interview') {
                Plex.inquiries.removePrescreenInterviewLink(inqRow);
            } else {
                inqRow.find('.uploadDoc-box[data-transcript-id="' + transcript_id + '"]').remove();
            }
            
            that.parents('.edit-upload-item-container').remove();

        } else {
            console.log("Failed");
        }
    });
});


Plex.inquiries.removePrescreenInterviewLink = function(inqRow) {
    var interviewSectionTitle = inqRow.find('.prescreen-interview-title'),
        interviewPlayer = inqRow.find('.prescreen-interview-player');

    inqRow.find('.interview-links[data-transcript-id="' + transcript_id + '"]').remove();

    var interviewLinksCount = inqRow.find('.sm2-playlist-wrapper > ul > li').length;

    soundManager.pauseAll();
    
    if (interviewLinksCount === 0) {
        interviewSectionTitle.addClass('hidden');
        interviewPlayer.addClass('hidden');
    }

    Plex.inquiries.resizeInterviewPlayList(inqRow);

}

Plex.inquiries.resizeInterviewPlayList = function(inqRow) {
    var isOpen = inqRow.find('.prescreen-interview-player').hasClass('playlist-open'),

        playListUL = inqRow.find('.sm2-playlist-drawer')[0];

    playListUL.style.height = (isOpen ? playListUL.scrollHeight : 0) + 'px';
}

//toggle select container and related component
Plex.inquiries.toggleSelectContainer = function(elem){
    var container = elem.closest('.component').find('.select-container');
    var select_field = container.find('select');
    var input_field = container.find('input[type="text"]');

    //hide or show containers
    if( elem.val() === 'all' ){
        Plex.inquiries.resetComponent(elem);
        container.addClass('hidden');
        Plex.inquiries.toggleComponents(select_field);
        Plex.inquiries.toggleComponents(input_field);
    }else{
        container.removeClass('hidden');
        container.find('.xclude-toggle').html(elem.val());
    }
};

//reset component back to default
Plex.inquiries.resetComponent = function(elem){
    var comp = elem.attr('name');
    var component_name = comp.slice(0, comp.indexOf('_'));

    //remove tag html and empty select field
    if( component_name === 'country' || component_name === 'department' ||
        component_name === 'startdate' || component_name === 'schooltype' ||
        component_name === 'financial' ){
        elem.closest('.search-filter-form').find('input[type="radio"][value="all"]').trigger('click').closest('.search-filter-form').clearSelectFieldAndTagList();
        component_name = elem.closest('li.search-tab').data('search-tab');

        //remove all tags by section from tags array
        Plex.inquiries.removeTagBySection(component_name);
    }else{
        elem.closest('.component').clearSelectFieldAndTagList();

        //remove all tags by component
        Plex.inquiries.removeTagByComponent(component_name);
    }

    // Plex.inquiries.updateFilterCrumbView();
};

$.fn.clearSelectFieldAndTagList = function(){
    this.find('select').val('').parent().find('.tag').remove();
    return this;
};
// -- all/include/exclude toggle


// -- search tab functions
$(document).on('click', '.search-tab a', function(e){
    e.preventDefault();
    var clicked_tab = $(this).parent().data('search-tab'), section = {};

    section = Plex.inquiries.sections.getSection(clicked_tab);
    if( section && section.locked ) return false;

    $('li.search-tab a').removeClass('active');

    //if clicked tab is already active just close it, otherwise open it
    if( clicked_tab === Plex.inquiries.activeTab ){
        Plex.inquiries.activeTab = null;
        Plex.inquiries.closeAllSearchFilterBoxes();
    }else{
        Plex.inquiries.activeTab = clicked_tab;
        Plex.inquiries.openSearchFilter();
        $(this).addClass('active');
    }
});

Plex.inquiries.closeAllSearchFilterBoxes = function(){
    $('.search-filter-form').removeClass('open').slideUp(10);
}

Plex.inquiries.openSearchFilter = function(){
    Plex.inquiries.closeAllSearchFilterBoxes();
    $('li[data-search-tab="'+Plex.inquiries.activeTab+'"]').find('.search-filter-form').addClass('open').slideDown(500);
}
// -- search tab functions

// -- populate select fields based on dependencies

//when year select field has changed values
$(document).on('change', '#startyr', function() {
    var _this = $(this);

    if(_this.val() != '') {
        $('.component.startterm').removeClass('hidden');
    }
});

//when state select field has changed values
$(document).on('change', '#s_states', function(){
    var _this = $(this);

    if(_this.val() != ''){
       Plex.inquiries.populateCityBasedOnState(_this.val());
    }
});

//when department select field has changed values
$(document).on('change', '#s_depts', function(){
    var _this = $(this);

    if(_this.val() != ''){
       Plex.inquiries.populateMajorBasedOnDepartment(_this.val());
    }
});

//get cities based on selected state
Plex.inquiries.populateCityBasedOnState = function(stateAbbr, fromInit){
    $.getJSON("/ajax/homepage/getCityByState/"+stateAbbr, function(result) {
        var options = $("#s_cities");
        Plex.inquiries.populate(options, result);
        if( fromInit ){
            Plex.inquiries.initCity();
        }
    });
}

//get majors based on selected department
Plex.inquiries.populateMajorBasedOnDepartment = function(departmentAbbr, fromInit){
    $.getJSON("/ajax/getMajorByDepartment/"+departmentAbbr.replace(/\//g, '&'), function(result) {
        var options = $("#s_majors");
        Plex.inquiries.populate(options, result);

        if( fromInit ){
            Plex.inquiries.initMajor();
        }
    });
}

Plex.inquiries.populate = function(target, data){
    target.find('option').remove();
    $.each(data, function(key, value) {
        target.append($("<option />").val(value).text(value));
    });
}

//In military if it is yes, show military affiliation else hide military affiliation dropdown
$(document).on('change', '#s_inMilitary', function(e){
    e.preventDefault();
    $(this).toggleMilitaryAffiliation();
});

$.fn.toggleMilitaryAffiliation = function(){
    var val = this.val(),
        militaryAffiliation = $('.militaryAffiliation');

    if( parseInt(val) ){
        militaryAffiliation.fadeIn(500);
    }else{
        militaryAffiliation.fadeOut(500);
        if( val === '' ) $('#s_inMilitary').val('');
    }

    return this;
}

$(document).on('click', '.more-option', function(e){
    var moreOptions = $('.more-option');
    var moreTab = $('.moreTab');
    if (moreOptions.text() == '+ More Filter Options') {
        moreTab.removeClass('hide');
        moreOptions.text('- Less Filter Options');
    }else{
        moreTab.addClass('hide');
        moreOptions.text('+ More Filter Options');
    }
});

// -- populate select fields based on dependencies


// open filter option
Plex.inquiries.switchIcon = function(elem) {
    var _this = elem;
    var icon = _this.find('img');
    var text = _this.find('.filter-text');
    var filter_options = $('#filter-options');

    if(filter_options.is(':visible')) {
        _this.addClass('active');
        icon.attr('src', '/images/setting/filter-blue.png');
    } else {
        _this.removeClass('active');
        icon.attr('src', '/images/setting/filter-white.png');
    }
}

/**********************************
    sort the current column
***********************************/
$(document).on('click', '.sort-col', function(event){
    
    // make an ajax call.
    var _this = $(this);
    var container = _this.parents('.main-manage-students-content').find('.each-inquirie-container');
    var order = _this.data('order');
    var orderBy = order['orderBy'];
    var sortBy  = order['sortBy'];
    var display_option = $('#displayOption option:selected').val();
    var page_type = container.data('page-type').split('-');
    var admin = page_type[0];
    var page = page_type[1];
    var is_reset = true;

    Plex.inquiries.loadMoreResults(page, admin, display_option, orderBy, sortBy, is_reset);

    
    //we want to reset sort to ASC on other columns so that when a user goes back
    //and if the user left that column in DESC
    //they have the standard/expected order again for smooth UX
    var data_att = null;

    $('.sort-col').each(function(){
        data_att = $(this).data('order'); //the data-order attribute for current element

        //if not current column user is interacting with
        if(event.target != $(this)[0]){ 

            //if ordering by date the default should be DESC not ASC
            if(data_att['orderBy'].trim() === "date")
                data_att['sortBy'] = "DESC";
            else
                data_att['sortBy'] = "ASC";
            
            $(this).attr('data-order', JSON.stringify(data_att));
        }
    });

    //once we order the list, we want to give users the option of ordering in the other direction
    //set sortBy to 'opposite'
    if(sortBy.trim() === "DESC"){
        order['sortBy'] = "ASC";
    }
    else{
        order['sortBy'] = "DESC";
    }  
    _this.attr( 'data-order', JSON.stringify(order));

});



// -- add display options
$(document).on('change', '#displayOption', function(e){
    e.preventDefault();
    // var _this = $('#filter-options');
    var container = $(this).parents('.main-manage-students-content').find('.each-inquirie-container');

    var display_option = $('#displayOption option:selected').val();

    var page_type = container.data('page-type').split('-');
    var admin = page_type[0];
    var page = page_type[1];
    var is_reset = false;

    var orderBy = typeof $(".hidden_orderBy").val() == 'undefined'?  null : $(".hidden_orderBy").val();
    var sortBy = typeof $(".hidden_sortBy").val() == 'undefined'? null : $(".hidden_sortBy").val();

    Plex.inquiries.loadMoreResults(page, admin, display_option, orderBy, sortBy, is_reset);
});

// -- load more functions
$(document).on('click', '.each-inquirie-container .load-more-btn', function(e){
	e.preventDefault();
	// var _this = $('#filter-options');
	var display_option = $('#displayOption option:selected').val();
	var container = $(this).closest('.each-inquirie-container');
	var page_type = container.data('page-type').split('-');
	var admin = page_type[0];
	var page = page_type[1];
    var is_reset = false;

    var orderBy = typeof $(".hidden_orderBy").val() == 'undefined'?  null : $(".hidden_orderBy").val();
    var sortBy = typeof $(".hidden_sortBy").val() == 'undefined'? null : $(".hidden_sortBy").val();

    Plex.inquiries.loadMoreResults(page, admin, display_option, orderBy, sortBy, is_reset);
});

//mixpanel track open export
$(document).on('click', '#exp-student-modal', function(e){
	mixpanel.track("View_Export_Students", {
		"location": document.body.id
	});
});

//ajax call to retrieve more results, if any
Plex.inquiries.loadMoreResults = function(page, admin, display_option, orderBy, sortBy, is_reset){
	var route = '/'+admin+'/ajax/'+page+'/true';
	// route = http://plexuss.dev/admin/ajax/approved/true
	var check = false;
	if(parseInt(display_option) != 0){
		route = route + '?display=' + display_option;
		check = true;
	}

	if (orderBy && sortBy ) {
		if (check) {
			route += '&orderBy='+orderBy.trim()+'&sortBy='+sortBy.trim();
		}else{
			route += '?orderBy='+orderBy.trim()+'&sortBy='+sortBy.trim();
			check = true;
		}
	}

	// is_reset : true means begin search from filter_audience, false means from loadMore and displayOption
	if(is_reset) {
		if(check) {
			route += '&init=1';
		}else {
			route += '?init=1';
		}
	} else {
		if(check) {
			route += '&init=0';
		}else {
			route += '?init=0';
		}
	}

	var hasResults = 1;

	// //show loader
	Plex.inquiries.showLoader();

	$.ajax({
		url: route,
		type: 'GET',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	}).done(function(results){

		var current_viewing = null;
		var total_results = null;
        var newHasResults = null;

		// hide loader
        Plex.inquiries.hideLoader();

		if(is_reset) {
            if(orderBy && sortBy) {
                if($('.hidden_sortBy').length == 0 && $('.hidden_orderBy').length == 0) {
                    var insert_hidden_elem = '<input type="hidden" name="orderBy" value="' + orderBy.trim() + '" class="hidden_orderBy">';
                    insert_hidden_elem += '<input type="hidden" name="sortBy" value="' + sortBy.trim() + '" class="hidden_sortBy">';
                    $(insert_hidden_elem).insertBefore('.main-managestudents-container');
                }
            }
			$('.each-inquirie-container').html('');
			$('.each-inquirie-container').html(results);
			$('.each-inquirie-container').append('<div class="row showResultsBar"><div class="column small-12 medium-4 large-4 showResults"></div><div class="column small-12 medium-8 large-8 load-more text-center"></div></div>');
			Plex.inquiries.injectLoadMoreButton();
		} else {
			//append new results to existing list of results
			$('.item.inquirie_row').last().after(results);
            // reinit owlCarousel
		}

		current_viewing = $('.inquirie_row').length;
		total_results = $('.total-bucket-count').text();
		//check if these are the last results
		hasResults = $('.hasResults').last().data('last-results');
		Plex.inquiries.hasResultsCheck(hasResults);

		$('.each-inquirie-container .showResults').html(Plex.inquiries.injectResults(current_viewing, total_results));

        var parseHTML = document.createElement('html');
        parseHTML.innerHTML = results;

        newHasResults = $(parseHTML).find('.hasResults');

        // Append results to auto-dialer list.
        var new_results = newHasResults.data('more-results');

        if (!_.isEmpty(new_results) && Plex.phonecall.autoDialerPeopleList) {
            var loadMoreButton = $('.load-more-btn:visible');
            var unfilteredAutoDialerList = Plex.phonecall.autoDialerPeopleList.concat(new_results);
            
            Plex.phonecall.autoDialerPeopleList = _.filter(unfilteredAutoDialerList, function(person) {
                return person.phone && person.phone != ' ' && Plex.phonecall.autoDialerBlackList.indexOf(person.student_user_id) === -1;
            });

            Plex.phonecall.updateAutoDialerPerson();

            if (loadMoreButton.length > 0 && _.isEmpty(Plex.phonecall.autoDialerPeopleList)) {
                loadMoreButton.trigger('click');
            }
        }

	});
}

//show ajax loader
Plex.inquiries.showLoader = function(){
	$('.manage-students-ajax-loader').show();
}

//hide ajax loader
Plex.inquiries.hideLoader = function(){
	$('.manage-students-ajax-loader').hide();
}

//remove 'load more' button and add no more results text when out of results
Plex.inquiries.hasResultsCheck = function(hasResults){
	if( hasResults !== 1 ){
		$('.load-more-btn').addClass('hide');
		$('.no-results-txt').removeClass('hide');
	}
}

//inject load more button onto page
Plex.inquiries.injectLoadMoreButton = function(){
	$('.each-inquirie-container .load-more').html(Plex.inquiries.loadMoreButton());
}

//build load more button
Plex.inquiries.loadMoreButton = function(){
	var btn = [
		'<a class="load-more-btn">show more results</a>',
		'<a class="no-results-txt hide">No more results</a>'
	].join("");

	return btn;
}
// -- load more functions

// show results
Plex.inquiries.injectResults = function(current_viewing, total_results) {
	var updateResult = "<div>Current Viewing : <span>" + current_viewing;
		updateResult +=  "</span></div><div>Total Results : <span class='total-bucket-count'>";
		updateResult += total_results;
		updateResult += "</span></div>";
	return updateResult;
}


//start interval when textarea has focus
$(document).on('focus', '.notes-textarea', function(){
	var these_notes = this;
	var student_id = $(this).data('studentid');

	//loop - every 5 seconds, while textarea is in focus, save the note
	Plex.inquiries.saveNotesInterval = setInterval(function(){
		Plex.inquiries.autosaveNotes( student_id, these_notes );
	}, 5000);
});

//stop interval when textarea is out of focus
$(document).on('blur', '.notes-textarea', function() {
	var _this = this;
	var this_student_id = $(this).data('studentid');

	//once out of focus, save note
	clearInterval(Plex.inquiries.saveNotesInterval);
	Plex.inquiries.autosaveNotes( this_student_id, this );
});

//autosave notes
Plex.inquiries.autosaveNotes = function( id, notes ){
	var note_data = $(notes).val();
	var last_saved = $(notes).parent().find('.last-saved-note-time');

	$('.save-note-ajax-loader').show();

	//post note and update 'last saved' time
	$.ajax({
		url: '/admin/inquiries/saveNote',
		type: 'POST',
		data: {user_id: id, note: note_data},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	})
	.done(function(time){
        $('.save-note-ajax-loader').hide();
        if(time === '*Input is empty.') {
            $(last_saved).text(time);
        } else {
            if (time == '0') {
                time = 'Just now';
            }

            $(last_saved).text('Last Saved: ' + time);
        }
	});
}

// Plexuss Note starts here
//start interval when textarea has focus
$(document).on('focus', '.plexuss-notes-textarea', function(){
    var these_notes = this;
    var student_id = $(this).data('studentid');

    //loop - every 10 seconds, while textarea is in focus, save the note
    Plex.inquiries.plexussSaveNotesInterval = setInterval(function(){
        Plex.inquiries.plexussAutosaveNotes( student_id, these_notes );
    }, 10000);
});

//stop interval when textarea is out of focus
$(document).on('blur', '.plexuss-notes-textarea', function() {
    var _this = this;
    var this_student_id = $(this).data('studentid');

    //once out of focus, save note
    clearInterval(Plex.inquiries.plexussSaveNotesInterval);
    Plex.inquiries.plexussAutosaveNotes( this_student_id, this );
});

//autosave notes
Plex.inquiries.plexussAutosaveNotes = function( id, notes ){
    var note_data = $(notes).val();
    var last_saved = $(notes).parent().find('.last-saved-note-time');

    $('.plexuss-save-note-ajax-loader').show();

    //post note and update 'last saved' time
    $.ajax({
        url: '/admin/studentsearch/setNote',
        type: 'POST',
        data: {user_id: id, note: note_data},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function(time){
        $('.plexuss-save-note-ajax-loader').hide();
        if(time === '*Input is empty.') {
            $(last_saved).text(time);
        } else {
            $(last_saved).text('Last Saved: ' + time);
        }
    });
}
// Plexuss Notes ends here

//hide arrows if not enough competition
Plex.inquiries.hideCompetitionCarouselArrows = function( items_total, items_allowed ){
	if( items_total <= items_allowed ){
		$('.competitor-carousel-arrow').hide();
	}else{
		$('.competitor-carousel-arrow').show();
	}
}



//arrow click for Competition carousel
Plex.inquiries.moveCompetitionCarousel = function( owls, arrow ){
	if( $(arrow).hasClass('leftarrow') ){
		owls.trigger('owl.prev');
	}else{
		owls.trigger('owl.next');
	}
}


//remove student click event
$(document).on('click', '.remove-student-col', function(){
	var this_student = $(this).data('studentid');
	var in_pending = $(this).data('in-pending').trim();
    Plex.inquiries.remove_student_elem = $(this);

    //open 'why are you removing?' modal
    $('#why-removing-appr-student-modal').foundation('reveal', 'open');

    var student = Plex.inquiries.remove_student_elem;

    // console.log('student id: ', student.data('studentid'));
    // console.log('in pending: ',student.data('in-pending'));

	mixpanel.track("Remove_Student",
		{
			"location": document.body.id
		}
	);

});


//remove student click event
$(document).on('click', '.remove-student-for-prescreened-col', function(){
    var rid = $(this).data('rid');
    var student = $(this);

    var inquirieRow = $(student).closest('.inquirie_row');

    $.ajax({
        url: '/admin/inquiries/removePrescreenedUser/'+ rid,
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        type: 'POST'
    }).done(function(data, textStatus, xhr) {
        if(data == "success"){
            $(student).closest('.inquirie_row').remove();
            topAlert(Plex.inquiries.removeFromPrescreenedSuccess);
            Plex.inquiries.removeStudentFromAutoDialer(inquirieRow.data('uid'));
        }else{
            topAlert(Plex.inquiries.removeFromPrescreenedFailed);
        }
    });

    mixpanel.track("Remove_Student_for_prescreened",
        {
            "location": document.body.id
        }
    );

});

$(document).on('change', '#why-removing-appr-student-modal .required-info-box', function(){
    Plex.inquiries.validateRemoveStudentModal(); 
});

$(document).on('change keyup', '#why-removing-appr-student-modal .other-txt', function(){
    Plex.inquiries.validateRemoveStudentModal();
})

$(document).on('click', '.close-remove-modal', function(){
    $('#why-removing-appr-student-modal').foundation('reveal', 'close');
    Plex.inquiries.clearRemoveModal();
});

Plex.inquiries.validateRemoveStudentModal = function(){
    var all_required_boxes = $('#why-removing-appr-student-modal .required-info-box'),
        valid = false;


    //if at least one of the required checkboxes are checked, check for required dependecies
    if( all_required_boxes.is(':checked') ){
        valid = true;
        $.each(all_required_boxes, function(){
            if( $(this).is(':checked') ){
                //if inaccurate info checkbox is checked, one of its sub options must be checked as well
                if( $(this).attr('id') === 'inaccurate-info' ){
                    valid = $('.inaccuracy-field').is(':checked');
                    if( !valid ) return false;
                }

                //if the other innaccurate info checkbox is checked, then the text input cannot be empty
                else if( $(this).attr('id') === 'innacurate-other' ) valid = !!$('#other-innacuracies-input').val();
            }
        });
    }

    if( valid ) Plex.inquiries.makeDisabled(false);
    else Plex.inquiries.makeDisabled(true);
}

Plex.inquiries.clearRemoveModal = function(){
    var all_req = $('#why-removing-appr-student-modal .required-info-box');
    $.each(all_req, function(){
        $(this).prop('checked', false).trigger('change');
    });
};

$(document).on('click', '.remove-std-btn', function(e){
    e.preventDefault();

    var student = Plex.inquiries.remove_student_elem;
    console.log('student id: ', student.data('studentid'));
    console.log('in pending: ',student.data('in-pending'));
    // save form info
    Plex.inquiries.saveReasonWhyRemovingStudent();
});

Plex.inquiries.saveReasonWhyRemovingStudent = function(){
    var formdata = new FormData( $('#why-removing-appr-student-modal form')[0] ),
        student = Plex.inquiries.remove_student_elem,
        student_id = $(student).data('studentid'),
        in_pending = student.data('in-pending').trim();

    $.ajax({
        url: '/admin/inquiries/reasonsWhyRemovingStudent/' + student_id,
        type: 'POST',
        data: formdata,
        enctype: 'multipart/form-data',
        contentType: false,
        processData: false,
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        success: function(data){
            Plex.inquiries.removeStudent(student, student_id, in_pending);
        },
        error: function(err){
            console.log('error: ', err);
        },
    });
}

Plex.inquiries.showCannotRemoveStudentError = function(elem){
    var msg = '';

    if( elem.attr('id') === 'inaccurate-info' ){
        msg = 'Inaccurate information was selected, but you must also choose one of its sub-options as well.';
    }else if( elem.attr('id') === 'inaccurate-other' ){
        msg = 'Other was selected, but you must also provide a reason in the text field.'
    }

    if( msg ) $('#why-removing-appr-student-modal .err-msg').val(msg).show();
}

$(document).on('change', '#innacurate-other', function(){
    if( $(this).is(':checked') ) $('#other-innacuracies-input').prop('disabled', false);
    else $('#other-innacuracies-input').prop('disabled', true).val('');
});

//why are you removing student modal
$(document).on('change', '#inaccurate-info', function(){
    if( $(this).is(':checked') ) $('.inaccuracy-field').prop('disabled', false);
    else $('.inaccuracy-field').prop('disabled', true).prop('checked', false);
});

Plex.inquiries.makeDisabled = function(bool){
    $('#why-removing-appr-student-modal .remove-std-btn').prop('disabled', bool);
}

//Add to H student click event
$(document).on('click', '.add-to-hsh', function(){
    var this_student = $(this).data('studentid');
    $.ajax({
        url: '/admin/inquiries/setAddToH',
        type: 'POST',
        data: {this_student: this_student},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function(dt) {
        console.log(dt);
    });
    
});

//remove student from list
Plex.inquiries.removeStudent = function(student, studentID, from_pending){
    var parent = $(student).closest('.inquirie_row'),
        recruitment_id = parent.data('recruitment_id');

    var currentPage = document.body.id;

    if (currentPage == 'admin-converted') {
        Plex.inquiries.removeStudentFromInquiries(student, recruitment_id);

        $('#why-removing-appr-student-modal').foundation('reveal', 'close');
        return;
    }

	$.ajax({
		url: '/admin/inquiries/setRecruit/' + studentID + '/' + Plex.inquiries.remove_this + '/true',
		type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	})
	.done(function() {
		//remove this student row from list after ajax call
		$(student).closest('.inquirie_row').remove();

		if( from_pending === 'true' ){
			topAlert(Plex.inquiries.removeFromPendingSuccessMsg);
		}else{
			topAlert(Plex.inquiries.removeFromApproveSuccessMsg);
		}

        $('#why-removing-appr-student-modal').foundation('reveal', 'close');

        Plex.inquiries.removeStudentFromAutoDialer(studentID);

        mixpanel.track('admin-removed', { Location: window.location.href.split('/').pop() });
	});
}

//remove student from inquiries
Plex.inquiries.removeStudentFromInquiries = function(student, recruitment_id){
    var studentID = $(student).closest('.inquirie_row').data('uid');

    $.ajax({
        url: '/admin/inquiries/setRecruitForInquiriesOrConverted/' + recruitment_id + '/' + Plex.inquiries.remove_this + '/true',
        type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function() {
        //remove this student row from list after ajax call
        $(student).closest('.inquirie_row').remove();

        topAlert(Plex.inquiries.removeFromInquiriesSuccess);

        $('#why-removing-appr-student-modal').foundation('reveal', 'close');

        Plex.inquiries.removeStudentFromAutoDialer(studentID);

        mixpanel.track('admin-removed', { Location: window.location.href.split('/').pop() });
    });
}

$(document).on('click', '.buttonColumn .columns .inquiries-remove-button', function() {
    var parent = $(this).closest('.inquirie_row'),
        student_id = parent.data('uid'),
        recruitment_id = parent.data('recruitment_id');

    Plex.inquiries.removeStudentFromInquiries(this, recruitment_id);
});

//restore student click event
$(document).on('click', '.restore-student-col', function(){
	var this_student = $(this).data('studentid');
	Plex.inquiries.restoreToInquiries(this, this_student);

	mixpanel.track("Restore_Student",
		{
			"location": document.body.id
		}
	);
});

// Track number of clicks on download button
$(document).on('click', '.dl_button', function(){

	mixpanel.track("Export_Students",
		{
			"location": document.body.id
		}
	);
});

$(document).on('click', '.ms-btns.filter-audience', function(e) {
   // var target = $(e.target);
    var filter_options= $('#filter-options');

    //position element under filter audience button
    var newLeft = $('.ms-btns.filter-audience').offset().left - 
    ( $('.manage-student-sidebar-menu').width() + $('#filter-options').width() ) + 
    $('.ms-btns.filter-audience').width();

    filter_options.css('left', newLeft + 'px');

    if(!filter_options.is(":visible")) {
        filter_options.css('display', 'block');
        Plex.inquiries.switchIcon($('a.ms-btns.filter-audience'));
    } else {
        filter_options.css('display', 'none');
        Plex.inquiries.switchIcon($('a.ms-btns.filter-audience'));
    }

});


//restore student from list
Plex.inquiries.restoreStudent = function(student, studentID){

	$.ajax({
		url: '/admin/inquiries/setRestore/' + studentID,
		type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	})
	.done(function() {
		//restore this student row from list after ajax call
		$(student).closest('.inquirie_row').remove();
		topAlert(Plex.inquiries.restoreFromRemovedMsg);
	});
}

Plex.inquiries.restoreToInquiries = function(student, studentID){
    $.ajax({
        url: '/admin/inquiries/setRestoreToInquiries/' + studentID,
        type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function() {
        //restore this student row from list after ajax call
        $(student).closest('.inquirie_row').remove();
        topAlert(Plex.inquiries.restoreFromRemovedToInquiriesMsg);
    });
}

Plex.inquiries.requestToBecomeMember = function(){

	$.ajax({
		url: '/admin/ajax/requestToBecomeMember',
		type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	})
	.done(function(){

	});
}

Plex.inquiries.split = function(val){
    return val.split(/,\s*/);
}

Plex.inquiries.extractLast = function(term) {
    return Plex.inquiries.split(term).pop();
}

Plex.inquiries.addStudentManual = function(type, user_id, college_id, aor_id, org_portal_id, aor_portal_id, school_name, callback){
    var at = Plex.inquiries.addStudentManuallyMsg;
    var org = $.extend({}, Plex.inquiries.addStudentManuallyMsg);

    //alert.msg = alert.msg.text.replace('{{type}}', type);
    var msg = at.msg;
    msg = msg.replace(/{{type}}/g, type);
    msg = msg.replace(/{{school_name}}/g, school_name);
    at.msg = msg;

    Plex.inquiries.showLoader();
    
    //console.log(aor_id, org_portal_id, aor_portal_id);
    $.ajax({
        type: 'POST',
        url: '/admin/studentsearch/addStudentManual',
        data: {type:type, user_id:user_id, college_id:college_id, school_name:school_name,
               aor_id:aor_id, org_portal_id:org_portal_id, aor_portal_id:aor_portal_id},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    })
    .done(function() {
        Plex.inquiries.hideLoader();
        topAlert(at);
        // console.log("success");
        callback();
    })
    .fail(function() {
        Plex.inquiries.hideLoader();
        topAlert(Plex.inquiries.error);
        callback();
    })
    Plex.inquiries.addStudentManuallyMsg = org;
}

/****************************************
*  need to initialize the majors list when the dropdown is opened
*  otherwise the list of majors is not on the page yet
*
****************************************/
Plex.inquiries.initMajors = function(uid){
    var txt = '';

    //empty majorsList
    Plex.inquiries.majorsList.clearList();

    $(".inquirie_row[data-uid='" + uid + "'] .sales-student-edit-pane").find('.major-listing').each(function(){
        
        //if not empty
        if($(this).text().trim()){
           
            txt = $(this).text().trim();

            //build crumb list
            Plex.inquiries.majorsList.addTextCrumb(txt);
        }
    });

    //append crumbs to view
    for(var i = 0; i < Plex.inquiries.majorsList.length(); i++){     
        $("[data-uid='" + uid + "']").find('.majors_crumb_list').append(Plex.inquiries.majorsList.crumbs[i].getCrumb());
    } 
};

/*************************************************
*
*   inits the total bucket count and counts the current number of students on screen currently
*
***************************************************/
Plex.inquiries.initBucketsCount = function() {
    var currentViewingCount = $('.inquirie_row').length;

    // Inquiries count
    $('.manage-students-tab .num_of_inquiry').html("<div class='very-mini-loader loader-right'></div>");

    if (document.body.id == 'admin-inquiries') {
        $('.each-inquirie-container .showResults').html(Plex.inquiries.injectResults(currentViewingCount, "<div class='very-mini-loader loader-inline'></div>"));
    }

    $.ajax({
        url: '/admin/inquiries/getInquiriesCount',
        method: 'GET',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    }).done(function(response) {
        if (document.body.id == 'admin-inquiries') {
            $('.each-inquirie-container .showResults').html(Plex.inquiries.injectResults(currentViewingCount, response.count));
        }
        
        $('.manage-students-tab .num_of_inquiry').html(response.count);
    });
    // End inquiries count

    // Converted count
    $('.manage-students-tab .num_of_converted').html("<div class='very-mini-loader loader-right'></div>");
    
    $.ajax({
        url: '/admin/inquiries/getConvertedCount',
        method: 'GET',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
    }).done(function(response) {
        $('.manage-students-tab .num_of_converted').html(response.count);
    });
    // End converted count

};

/*************************************************
*
*   inject profile via ajax,  can also refresh profile...(may seperate later)
*
***************************************************/
Plex.inquiries.injectProfile = function(that){
    var inqRow = that.parents('.inquirie_row');
    var hashedid = inqRow.data('hashedid');
    var college_id = $('.hasResults').data('college');
    var all_inquiries_container = $('.each-inquirie-container');
    var profile_pane = inqRow.find('.sales-student-pane');
    var editPane = inqRow.find('.sales-student-edit-pane'); 
    var uid = that.parents('.inquirie_row').data('uid');

    //get the current page
    var currentPage = $('.each-inquirie-container').data('page-type');
    var page = '';
    var postRouteURL = (currentPage === 'admin-student-search') ? 
        'studentsearch/loadProfileData' : 'inquiries/loadProfileData';
    

    //get current
    if(currentPage) {
        page = currentPage.split('-').slice(1).join('-');
    }

    Plex.inquiries.showLoader();

    //ajax flag (per row) to not make repeat ajax request
    inqRow.addClass('loading');

    $.ajax({
                url: '/admin/' + postRouteURL,
                type: 'POST',
                data: {currentPage: page,
                       hashedId: hashedid,
                       hashed_user_id: hashedid,// named differently for studentsearch/loadProfileData
                           collegeId: college_id },
                headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
                })
                .done(function(response){

                    Plex.inquiries.hideLoader();
                    inqRow.removeClass('loading');

                // restarting sound manager is required if interview already exist on profile pane
                // causes unwanted behavior otherwise
                restartSoundManager(inqRow);

                 //hide all other profiles
                $('.inquirie_row.viewing').each(function(){
                    $(this).removeClass('.viewing');
                    $(this).find('.dropdownbox').slideUp( 250, 'easeInOutExpo' );
                    $(this).find('.dropdownbox').addClass('hidden');
                    $(this).find('.active').removeClass('active');
                    $(this).find('.arrow').removeClass('opened');
                });


                //remove old profile pane if existing
                profile_pane.remove();
                editPane.remove();

                if (currentPage === 'admin-student-search') {
                    inqRow.find('.full-profile-container').append(response);
                    
                } else {
                    //add new profile pane
                    inqRow.append(response);
                   
                }
                // //add new profile pane
                // inqRow.append(response);

                // -- get back here
                requiredAfterAjax(that, inqRow);
                
            });


}

/**************************************
*  used in advanced student search
*
***************************************/
function requiredAfterAjax(that, inqRow){

    var all_inquiries_container = $('.each-inquirie-container');
    var profile_pane = inqRow.find('.sales-student-pane');    
    var uid = inqRow.data('uid');
    var inqdropdown = inqRow.find('.dropdownbox');
    var currentPage = $('.each-inquirie-container').data('page-type');


    if(!inqRow.hasClass('loadedProfile'))
        inqRow.addClass('loadedProfile'); //has a loaded profile now

    
    //re-initialize foundation equalizer
    $(document).foundation('equalizer', 'reflow');
    $(document).foundation('interchange', 'reflow');
    Plex.inquiries.initNewOwl();

    Plex.inquiries.initMajors(uid);

    // initialize mp3 player if interview exist
    if (inqRow.find('.prescreen-interview-player').length > 0) {
        // basicMP3Player = new BasicMP3Player();
        restartSoundManager(inqRow);
        soundManager.onready(basicMP3Player.init);
    }

    //re init foundation form validation
    // $(document).foundation('abide', 'reflow');
    inqRow.find('#salesProfileEdit').foundation('abide');


    // //init and reinit TinyMCE (editor for editing templates)
    // tinymce.EditorManager.editors = [];
    // // tinymce.execCommand('mceAddControl', true, 'editMsgTemplate-editor');
    // tinymce.init({
    //             selector:'#editMsgTemplate-editor',
    //             imagetools_cors_hosts: ['www.tinymce.com', 'codepen.io'],
    //             plugins:  ['link code'],
    //             setup: function (editor) {

    //                 editor.on('change', function(e){
    //                     Plex.msgTemplates.selectedTemplate.edit('content', editor.getContent());
    //                 });
    //                 editor.on('keyup', function(){
    //                     Plex.msgTemplates.selectedTemplate.edit('content', editor.getContent());
    //                 });
    //                 editor.on('click', function(){
    //                     console.log('clicked!');
    //                 });
    //             }
    // });

    inqdropdown.slideDown();
    inqdropdown.removeClass('hidden');
    
    that.addClass('active');
    inqRow.addClass('viewing');
  
    initializeStudentCarousel(inqRow)
}

function initializeStudentCarousel(inqRow) {
    var uid = inqRow.data('uid');
    var fitBtn = inqRow.find('.fit-competitor-btns.fit'),
        competitorBtn = inqRow.find('.fit-competitor-btns.competitor'),
        appliedBtn = inqRow.find('.fit-competitor-btns.applied'),
        fitCarousel = inqRow.find('.fit-carousel'),
        competitorCarousel = inqRow.find('.competitor-carousel'),
        appliedCarousel = inqRow.find('.applied-carousel'),
        statusBtn = inqRow.find('.fit-status');

    var student_pane = inqRow.find('.sales-student-pane');
    var shouldShowMatchedColleges = student_pane.data('show-matched');
    
    if( +shouldShowMatchedColleges ) getMatchedCollegesForThisUser(uid, fitCarousel.find('.student-profile-matched'));

    if( fitBtn.length > 0 || appliedBtn.length > 0 ) { 
        _Move.initRx(
            fitBtn, 
            competitorBtn, 
            appliedBtn,
            fitCarousel, 
            competitorCarousel, 
            appliedCarousel,
            statusBtn
        );
    }
}

function restartSoundManager(inqRow){
    if (inqRow.find('.prescreen-interview-player').length > 0 || inqRow.find('.prev-call-container').length > 0) {
        soundManager.pauseAll();
        soundManager.soundIDs.forEach(function(id) {
            soundManager.destruct(id);
        });
        soundManager.reboot();
    }
}


function inquiriesToggleProfile(el){
    var _this = $(el);
    var cont = _this.closest('.messageName');
    var inqRow = _this.parents('.inquirie_row');
    var inqdropdown = inqRow.find('.dropdownbox');
    var hashedid = _this.data('hashedid');
    var college_id = $('.hasResults').data('college');
    var all_inquiries_container = $('.each-inquirie-container');
    var profile_pane = inqRow.find('.student-profile-pane');

    var uid = _this.parents('.inquirie_row').data('uid');

    //get the current page
    var currentPage = $('.each-inquirie-container').data('page-type');
    var page = '';
    if(currentPage) {
        page = currentPage.split('-').slice(1).join('-');
    }

    Plex.contact.currentThread = -1;

    //if opened -- close
    if (_this.hasClass('active')) {
        _this.removeClass('active');
        inqdropdown.addClass('hidden');
        inqdropdown.slideUp( 250, 'easeInOutExpo' );
        inqRow.removeClass('viewing');
        // tinymce.execCommand('mceRemoveControl', true, 'editMsgTemplate-editor');
    }//else load and inject profile or open
    else{
        

        //////// AJAX to set college viewing
        $.ajax({
            url: '/admin/ajax/setCollegeViewingYourProfile',
            type: 'POST',
            data: {hashedid: hashedid},
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        })
        .done(function(data) {
            if( $(inqRow).hasClass('unread') ){
                $(inqRow).removeClass('unread').addClass('read');
            }    

        });


        /////// 
        //if not profile info not already loaded or trying to load -> 
        // AJAX to load profile information
        if(!inqRow.hasClass('loadedProfile') && !inqRow.hasClass('loading')){
            

            Plex.inquiries.injectProfile(_this); 
            
           
        }//else already loaded from server -- just slide down
        else{
            
            //hide all other profiles
            $('.inquirie_row.viewing').each(function(){
                $(this).removeClass('.viewing');
                $(this).find('.dropdownbox').slideUp( 250, 'easeInOutExpo' );
                $(this).find('.dropdownbox').addClass('hidden');
                $(this).find('.active').removeClass('active');
                $(this).find('.arrow').removeClass('opened'); 
                // tinymce.execCommand('mceRemoveControl', true, 'editMsgTemplate-editor');
            });

            inqdropdown.slideDown( 250, 'easeInOutExpo' ); 
            inqRow.addClass('viewing');
            inqdropdown.removeClass('hidden');
            _this.addClass('active');
            inqRow.addClass('viewing');
            // tinymce.execCommand('mceAddControl', true, 'editMsgTemplate-editor');
           
            // initPhoneCall(inqRow);

        }
        
    }       


    cont.find('.arrow').toggleClass('opened');

    mixpanel.track("View_Profile",
        // Mixpanel
        {
            "location": document.body.id
        }
    );


}

function inquiriesToggleMenu(el){
	var _this = $(el);
	var inqRow = _this.parents('.inquirie_row');
	var inqdropdown = inqRow.find('.dropdownbox');
	var hashedid = _this.data('hashedid');
    var college_id = $('.hasResults').data('college');
	var all_inquiries_container = $('.each-inquirie-container');
	var profile_pane = inqRow.find('.student-profile-pane');

    var uid = _this.parents('.inquirie_row').data('uid');

    //get the current page
    var currentPage = $('.each-inquirie-container').data('page-type');
    if(currentPage) {
        currentPage = currentPage.split('-');
    }
    


    var adminType = currentPage[0];
    var page = currentPage[1];

	//scroll to bottom of container when multiple student profile panes are open
	// $(all_inquiries_container).stop().animate({
	//   scrollTop: inqRow.position().top - all_inquiries_container.position().top
	// }, 500);


	$(el).find('.arrow').toggleClass('opened');

	if (_this.hasClass('active')) {
		_this.removeClass('active');
		inqdropdown.slideUp( 250, 'easeInOutExpo' );
	} else {
		_this.addClass('active');
		
        //////// AJAX to set college viewing
		$.ajax({
			url: '/admin/ajax/setCollegeViewingYourProfile',
			type: 'POST',
			data: {hashedid: hashedid},
            headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
		})
		.done(function(data) {

            //Plex.inquiries.initOwlCarousel();

			if( $(inqRow).hasClass('unread') ){
				$(inqRow).removeClass('unread').addClass('read');
			}    

		});


        /////// AJAX to load profile information
        //if not profile info not already loaded or trying to load -- append
        if(!inqRow.hasClass('loadedProfile') && !inqRow.hasClass('loading')){
            Plex.inquiries.showLoader();

            //ajax flag (per row) to not make repeat ajax request
            inqRow.addClass('loading');
            
            $.ajax({
                url: '/admin/inquiries/loadProfileData',
                type: 'POST',
                data: {currentPage: page,
                       hashedId: hashedid,
                       collegeId: college_id },
                headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')}, 
            })
            .done(function(response){

                Plex.inquiries.hideLoader();
                inqRow.removeClass('loading');
                inqRow.append(response);
               
                inqRow.addClass('loadedProfile'); //has a loaded profile now


                inqdropdown.slideDown(250, 'easeInOutExpo');
                
                //re-initialize foundation equalizer
                $(document).foundation('equalizer', 'reflow');
                $(document).foundation('interchange', 'reflow');
                Plex.inquiries.initNewOwl();

                Plex.inquiries.initMajors(uid);
            });
        }else{
            inqdropdown.slideDown( 250, 'easeInOutExpo' );  

        }
        
    }       

	mixpanel.track("View_Profile",
        // Mixpanel
		{
			"location": document.body.id
		}
	);

}

function SendRecruithandShakeStatus( userId , status, elem, recommended ){
	//get the inquire row.
	var dataRow = $(elem).parents('.inquirie_row');

	//find the hand shake indicators and turn them off.
	dataRow.find('.yesnobuttons').removeClass('selected');
	dataRow.find('.messageIconArea').removeClass('selected');

	var yesStatus = '';
	var noStatus = '';
	var	messageIconStatus = '';

	var set_route = '';

	var location = '';
	var recruitStatus = '';

	//set route - different routes for recommended students and recruited students
	if( recommended === true ){
		set_route = '/admin/inquiries/setRecommendationRecruit/';
		location = 'Recommended';
	}else{
		set_route = '/admin/inquiries/setRecruit/';
		location  = 'Inquiries';
	}

	//Set status variables
	if (status == 1) {
		yesStatus = 'selected';
		messageIconStatus = 'selected';
		recruitStatus = 'Recruit_Yes';
	} else {
		noStatus = 'selected';
		recruitStatus = 'Recruit_No';

	};

	//Mixpanel track
	mixpanel.track(recruitStatus,
		{
			"location": location
		}
	);

	$.ajax({
		url: set_route + userId+'/' + status,
		type: 'POST',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
	})
	.done(function() {
		//set all the indicators status one call back.
		dataRow.find('.yesbutton').addClass(yesStatus);
		dataRow.find('.messageIconArea').addClass(messageIconStatus);
		dataRow.find('.nobutton').addClass(noStatus);

		if( status === 1 ){
			if( recommended === true ){
				topAlert(Plex.inquiries.addedFromRecommendedToPending);
				//remove this student row from list after ajax call
				$(elem).closest('.inquirie_row').remove();
			}else{
				topAlert(Plex.inquiries.addedFromInquiriesToApproved);
			}
		}
	});
}

// set cursor at the end of input
/*
function focusCampo(id) {
    var inputField = document.getElementById(id);
    if (inputField != null && inputField.value.length != 0) {
        if (inputField.createTextRange) {
            var FieldRange = inputField.createTextRange();
            FieldRange.moveStart('character', inputField.value.length);
            FieldRange.collapse();
            FieldRange.select();
        } else if (inputField.selectionStart || inputField.selectionStart == '0') {
            var elemLen = inputField.value.length;
            inputField.selectionStart = elemLen;
            inputField.selectionEnd = elemLen;
            inputField.blur();
            inputField.focus();
        }
    } else {
        inputField.focus();
    }
}
*/


function setInterviewStatus(elem, status, id){
    $.ajax({
        url: '/admin/ajax/setInterviewStatus',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        data: {interview_status: status, user_id: id},
        type: 'POST'
    }).done(function(data){
        var _elem = $(elem);
        _elem.closest('.buttonColumn').find('.yesnobuttons').css({backgroundColor: '#959595'});
        _elem.css({backgroundColor: '#24b26b'});
    });
}

function setAppliedEnrolledPrescreened(elem, appl_enroll, id){
    $.ajax({
        url: '/admin/ajax/setAppliedEnrolledPreScreened',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        data: {user_applied_enrolled: appl_enroll, user_id: id},
        type: 'POST'
    }).done(function(data){
        var _elem = $(elem);
        if(  _elem.hasClass('no') ){
            _elem.addClass(appl_enroll).removeClass('no');
        }else{
            _elem.addClass('no').removeClass(appl_enroll);
        }
    });
}



/* \\\\\\\\\\\\\\\\\\\\\ recommendations - start ///////////////////// */



/* \\\\\\\\\\\\\\\\\\\\\ recommendations - end ///////////////// */

Plex.inquiries.postStudent = function(user_id){
    $.ajax({
        url: '/admin/distribution/generatePostUrl',
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        data: {user_id: user_id},
        type: 'POST'
    }).done(function(data){
        if(data.success === 1)
            topAlert(Plex.inquiries.postStudentMsg);
        else
            topAlert(Plex.inquiries.postStudentMsgRejected);
    });
}

$(document).on('click', '.view-app-btn', function(){
    var _this = $(this),
        student_id = _this.data('studentid'),
        user_id = _this.closest('.inquirie_row').data('uid');

       amplitude.getInstance().logEvent('College Reviewed OneApp', { user_id: user_id });
   
       Plex.inquiries.viewApplication(student_id);
});

Plex.inquiries.viewApplication = function(id){
    window.open('/view-student-application/'+id);
}

// ---- move student
$(document).on('click', '.fit-status', function(){
    var menu = $(this).data('school');
    var school_id = $(this).data('id');
    var elem_to_open = $('.move-student-menu[data-school="'+menu+'"]');

    getOrganizationPortalsForThisCollege(school_id, elem_to_open);
});

$(document).on('click', '.move-back', function(){
    $(this).closest('.move-student-menu').hide();
});

$(document).on('click', '.move-btn', function(){
    var elem = $(this),
        school_id = elem.data('school'),
        user_id = elem.data('user'),
        portals = elem.closest('.move-student-menu').find('input[type="radio"]'),
        port_obj = null;

    var portal = Rx.Observable.from(portals)
                              .subscribe(function(elem){
                                var e = $(elem);
                                if( e.is(':checked') ) port_obj = e.data('port');
                              });

    if( port_obj !== null ){
        port_obj.user_id = user_id;
        port_obj.type = 'PreScreened';
        port_obj.college_id = school_id;
        moveThisStudentToThisSchool(port_obj, elem);
    }
});

function moveThisStudentToThisSchool(port_obj, btn){
    $.ajax({
        type: 'POST',
        url: '/admin/studentsearch/addStudentManual',
        data: port_obj,
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        success: function(){
            btn.closest('.move-student-menu').toggle();
        },
        error: function(){

        }
    });
}

function getOrganizationPortalsForThisCollege(school, modal){
    $.ajax({
        type: 'POST',
        url: '/admin/studentsearch/getOrganizationPortalsForThisCollege',
        data: {college_id: school},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        success: function(ret){
            var portals_li = buildPortals(ret);
            console.log('modal: ', modal);
            modal.find('ul').html(portals_li);
            modal.show();
        },
        error: function(){

        }
    });
}

function buildPortals(portals){
    var html = '';
    var list = [];

    if( portals.general ) list.push(portals.general);
    if( portals.portals ) list = list.concat(portals.portals);

    var results = Rx.Observable.from(list)
                               .subscribe(function(port){
                                    var sch_name = 'portal__' + port.school_name.split(' ').join('_');
                                    var name = port.org_portal_name || port.aor_portal_name;
                                    var port_name = name.split(' ').join('_');
                                    var str = JSON.stringify(port);
                                    html += ('<li data-tag-val="'+port.id+'">');
                                    html += ('<label for="portal__'+port_name+'">');
                                    html += ("<input id='portal__"+port_name+"' type='radio' name='"+sch_name+"' value='"+port.id+"' data-port='"+str+"' />");
                                    html += (name);
                                    html += ('</label>');
                                    html += ('</li>');
                               });

    return html;
};

$(document).on('keydown', '#_hasApplied', _.debounce(function(){
    searchForSchool( $(this).val() );
}, 500));

function searchForSchool(val){
    $.ajax({
        type: 'POST',
        url: '/admin/ajax/hasAppliedToFilterAutoComplete',
        data: {input: val},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        success: function(ret){
            var results = buildSchoolResults(ret.data);
            $('#_hasApplied_results').show().html(results);
        },
    });
}

function buildSchoolResults(list){
    if( !list || list.length === 0 ) return '<li class="text-center">No results</li>';

    var html = '';
    var results = Rx.Observable.from(list)
                               .subscribe(function(school){
                                    html+= ('<li data-tag-val="'+school.id+'">'+school.school_name+'</li>');
                               });

    return html;
}

$(document).on('click', '#_hasApplied_results > li[data-tag-val]', function(){
    var _this = $(this),
        val_text = _this.text(),
        belongsTo = _this.closest('li.search-tab').data('search-tab'),
        val = _this.data('tag-val');

    // (belongs, val, type, text, option)
    Plex.inquiries.saveTag( belongsTo, val, belongsTo, val_text, null);
    Plex.inquiries.updateTagListView(_this, 'hasApplied'); 

    $('#_hasApplied').val('');
    $('#_hasApplied_results').hide();
});

function getMatchedCollegesForThisUser(user_id, carousel){
    var loader = carousel.find('.matched-loading');

    loader.show();

    $.ajax({
        type: 'POST',
        url: '/admin/inquiries/getMatchedCollegesForThisUser',
        data: {user_id: user_id},
        headers: {'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')},
        success: function(schools){
            loader.hide();
            var parsed_schools = JSON.parse(schools);

            if( parsed_schools.length ) buildMatchedSchools(parsed_schools, carousel);

            $(document).foundation('equalizer', 'reflow');
            $(document).foundation('interchange', 'reflow');
            Plex.inquiries.initNewMatchedOwl();
        },       
    });
}

function buildMatchedSchools(schools, carousel){
    var html = '';

    $.each(schools, function(){
        html += '<div class="item text-center">';

        html +=     '<div class="row">';
        html +=         '<div class="column small-12">';
        html +=             '<div class="college-logos-background" data-interchange="['+this.logo_url+', (default)]"></div>';
        html +=         '</div>';
        html +=     '</div>';

        html +=     '<div class="row" data-equalizer-watch>';
        html +=         '<div class="column small-12 college-competitor-name competition-school-name-lg">';
        html +=             '<a target="_blank" href="/college/'+this.slug+'">'+this.school_name+'</a>';
        html +=         '</div>';
        html +=     '</div>';

        html +=     '<div class="row">';
        html +=         '<div class="column small-12 page-views">';

        if( this.hasApplied === 1 )      html += '<div class="fit-status good" data-id="'+this.college_id+'" data-school="'+this.school_name+'">&check;</div>';
        else if( this.hasApplied === 0 ) html += '<div class="fit-status mild" data-id="'+this.college_id+'" data-school="'+this.school_name+'">&check;</div>';
        else                             html += '<div class="fit-status none" data-id="'+this.college_id+'" data-school="'+this.school_name+'">+</div>';

        html +=         '</div>';
        html +=     '</div>';

        html += '</div>';
    });

    carousel.html(html);
    buildMoveMenus(schools);
}

function buildMoveMenus(schools){
    var html = '',
        div = $('#all-move-menus'),
        student_user_id = div.data('school-id');

    $.each(schools, function(){
        html += '<div class="move-student-menu" data-school="'+this.school_name+'">';
            html += '<div class="school">';
                html += '<div class="logo" data-interchange="['+this.logo_url+', (default)]"></div>';
                html += '<div>'+this.school_name+'</div>';
                html += '<div>Cambridge, MA</div>';
            html += '</div>';
            html += '<div style="margin: 10px 0;"><b>Select Portal</b></div>';
            html += '<ul></ul>';
            html += '<div class="actions">';
                html += '<div><u class="move-back">Back</u></div>';
                html += '<div><div class="move-btn" data-school="'+this.college_id+'" data-user="'+student_user_id+'">Move</div></div>';
            html += '</div>';
        html += '</div>';
    }); 

    div.html(html);
}

